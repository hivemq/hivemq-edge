{
  "definitions": {
    "Publish.quota": {
      "type": "object",
      "metadata": {
        "states": [
          {
            "name": "Connected",
            "description": "Entered when MQTT client has successfully connected to the broker.",
            "type": "INTERMEDIATE"
          },
          {
            "name": "Disconnected",
            "description": "Entered when MQTT client disconnects after sending the configured amount of publishes.",
            "type": "SUCCESS"
          },
          {
            "name": "Initial",
            "description": "Entered as soon as MQTT client is matched by the policy.",
            "type": "INITIAL"
          },
          {
            "name": "Publishing",
            "description": "Entered when MQTT client sends the first publish message.",
            "type": "INTERMEDIATE"
          },
          {
            "name": "Violated",
            "description": "Entered when MQTT client disconnects after sending too few or too many messages.",
            "type": "FAILED"
          }
        ],
        "transitions": [
          {
            "fromState": "Initial",
            "toState": "Connected",
            "description": "Triggered when MQTT client connects.",
            "event": "Mqtt.OnInboundConnect"
          },
          {
            "fromState": "Connected",
            "toState": "Publishing",
            "guards": "isMaxPublishNotZero",
            "description": "Triggered when MQTT client publishes a message for the first time.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Publishing",
            "toState": "Violated",
            "guards": "isPublishCountMoreThanOrEqualToMax",
            "description": "Triggered when MQTT client sends more publishes than the maximum allowed.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Publishing",
            "toState": "Publishing",
            "description": "Triggered when MQTT client sends consecutive publishes within conditions.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Connected",
            "toState": "Violated",
            "guards": "isPublishCountLessThanMin",
            "description": "Triggered when MQTT client disconnects before sending enough publishes.",
            "event": "Connection.OnDisconnect"
          },
          {
            "fromState": "Publishing",
            "toState": "Violated",
            "guards": "isPublishCountLessThanMin",
            "description": "Triggered when MQTT client sends less publishes than the minimum required.",
            "event": "Connection.OnDisconnect"
          },
          {
            "fromState": "Connected",
            "toState": "Disconnected",
            "description": "Triggered when MQTT client disconnects.",
            "event": "Connection.OnDisconnect"
          }
        ]
      },
      "properties": {
        "arguments": {
          "title": "Publish - Quota",
          "description": "The Publish - Quota model tracks the number of MQTT PUBLISH messages a client sends after a client connects to the broker to identify unusual behavior. When you configure a publish-quota model, at least one of the available arguments must be present. Data Hub uses the default value for the missing parameter.",
          "type": "object",
          "required": ["maxPublishes", "minPublishes"],
          "properties": {
            "minPublishes": {
              "title": "Minimum number of messages",
              "description": "Defines the minimal number of published messages that must be reached before disconnecting. The default value is 0.",
              "type": "integer",
              "default": 0,
              "minimum": 0
            },
            "maxPublishes": {
              "title": "Maximum number of messages",
              "description": "Defines the maximal number of published messages that must be reached before disconnecting. The default value for maxPublishes is -1 (for unlimited).",
              "type": "integer",
              "default": -1,
              "minimum": -1
            }
          }
        }
      }
    },
    "Mqtt.events": {
      "type": "object",
      "metadata": {
        "states": [
          {
            "name": "Connected",
            "description": "Entered when a client has successfully connected to the broker.",
            "type": "INTERMEDIATE"
          },
          {
            "name": "Disconnected",
            "description": "Entered when a client disconnects",
            "type": "SUCCESS"
          },
          {
            "name": "Initial",
            "description": "Entered as soon as a client is matched by the policy.",
            "type": "INITIAL"
          }
        ],
        "transitions": [
          {
            "fromState": "Initial",
            "toState": "Connected",
            "description": "Triggered when MQTT client connects.",
            "event": "Mqtt.OnInboundConnect"
          },
          {
            "fromState": "Connected",
            "toState": "Connected",
            "description": "Triggered when MQTT client subscribes to a message.",
            "event": "Mqtt.OnInboundSubscribe"
          },
          {
            "fromState": "Connected",
            "toState": "Connected",
            "description": "Triggered when MQTT client publishes a message.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Connected",
            "toState": "Connected",
            "description": "Triggered when MQTT client disconnects.",
            "event": "onInboundDisconnect"
          },
          {
            "fromState": "Connected",
            "toState": "Disconnected",
            "description": "Triggered when MQTT client disconnects.",
            "event": "Connection.OnDisconnect"
          }
        ]
      },
      "properties": {
        "arguments": {
          "title": "MQTT - Events",
          "description": "The MQTT - Events behavior model allows you to intercept specific MQTT packets for further actions. The model itself does not enforce any particular behavior and is very useful in debugging scenarios. This model does not require any arguments.",
          "type": "object",
          "required": [],
          "properties": {}
        }
      }
    },
    "Publish.duplicate": {
      "type": "object",
      "metadata": {
        "states": [
          {
            "name": "Connected",
            "description": "Entered when MQTT client has successfully connected to the broker.",
            "type": "INTERMEDIATE"
          },
          {
            "name": "Disconnected",
            "description": "Entered when MQTT client disconnects and has always sent different consecutive messages.",
            "type": "SUCCESS"
          },
          {
            "name": "Duplicated",
            "description": "Entered when MQTT client has sent a message which is equal to the previous one.",
            "type": "INTERMEDIATE"
          },
          {
            "name": "Initial",
            "description": "Entered as soon as MQTT client is matched by the policy.",
            "type": "INITIAL"
          },
          {
            "name": "NotDuplicated",
            "description": "Entered when MQTT client has sent its first message or two consecutive messages are different.",
            "type": "INTERMEDIATE"
          },
          {
            "name": "Violated",
            "description": "Entered when MQTT client disconnects and has always sent different consecutive messages.",
            "type": "FAILED"
          }
        ],
        "transitions": [
          {
            "fromState": "Initial",
            "toState": "Connected",
            "description": "Triggered when MQTT client connects.",
            "event": "Mqtt.OnInboundConnect"
          },
          {
            "fromState": "Connected",
            "toState": "NotDuplicated",
            "description": "Triggered when MQTT client sends the first publish.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "NotDuplicated",
            "toState": "NotDuplicated",
            "guards": "isDifferentPayload",
            "description": "Triggered when MQTT client sends a publish and the payload is different from the previous one.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "NotDuplicated",
            "toState": "Duplicated",
            "guards": "isSamePayload",
            "description": "Triggered when MQTT client sends a publish with the same payload as the previous one.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Duplicated",
            "toState": "NotDuplicated",
            "guards": "isDifferentPayload",
            "description": "Triggered when MQTT client sends a publish and the payload is different from the previous one.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Duplicated",
            "toState": "Duplicated",
            "guards": "isSamePayload",
            "description": "Triggered when MQTT client sends a publish with the same payload as the previous one.",
            "event": "Mqtt.OnInboundPublish"
          },
          {
            "fromState": "Duplicated",
            "toState": "Violated",
            "description": "Triggered when MQTT client disconnects while in the Duplicated state.",
            "event": "Connection.OnDisconnect"
          },
          {
            "fromState": "NotDuplicated",
            "toState": "Violated",
            "guards": "anyMessageDuplicate",
            "description": "Triggered when MQTT client disconnects and the Duplicated state has been reached during this connection.",
            "event": "Connection.OnDisconnect"
          },
          {
            "fromState": "Connected",
            "toState": "Disconnected",
            "description": "Triggered when MQTT client disconnects.",
            "event": "Connection.OnDisconnect"
          },
          {
            "fromState": "NotDuplicated",
            "toState": "Disconnected",
            "description": "Triggered when MQTT client disconnects while in the NotDuplicated state.",
            "event": "Connection.OnDisconnect"
          }
        ]
      },
      "properties": {
        "arguments": {
          "title": "Publish - Duplicate",
          "description": "The Publish - Duplicate model identifies consecutive identical client messages to prevent unnecessary resource consumption. This model does not require any arguments.",
          "type": "object",
          "required": [],
          "properties": {}
        }
      }
    }
  },
  "type": "object",
  "required": ["id", "model"],
  "properties": {
    "id": {
      "title": "id",
      "description": "The unique id of this behaviour policy",
      "type": "string",
      "pattern": "^[A-Za-z][A-Za-z0-9._-]{0,1023}$"
    },
    "model": {
      "title": "Behavior Model",
      "description": "Select the behavior model you want to use for this policy.",
      "default": "Mqtt.events",
      "enum": ["Mqtt.events", "Publish.duplicate", "Publish.quota"]
    }
  },
  "allOf": [
    {
      "if": {
        "type": "object",
        "properties": {
          "model": {
            "const": "Publish.quota"
          }
        }
      },
      "then": {
        "type": "object",
        "$ref": "#/definitions/Publish.quota"
      }
    },
    {
      "if": {
        "type": "object",
        "properties": {
          "model": {
            "const": "Mqtt.events"
          }
        }
      },
      "then": {
        "type": "object",
        "$ref": "#/definitions/Mqtt.events"
      }
    },
    {
      "if": {
        "type": "object",
        "properties": {
          "model": {
            "const": "Publish.duplicate"
          }
        }
      },
      "then": {
        "type": "object",
        "$ref": "#/definitions/Publish.duplicate"
      }
    }
  ]
}
