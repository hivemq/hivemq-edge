<?xml version="1.0"?>
<hivemq>
    <mqtt-listeners>
        ${IF:HIVEMQ_MQTT_ENABLED}
        <tcp-listener>
            <port>1883</port>
            <bind-address>0.0.0.0</bind-address>
        </tcp-listener>
        ${IF:HIVEMQ_MQTT_ENABLED}
        ${IF:HIVEMQ_MQTTS_ENABLED}
        <tls-tcp-listener>
            <port>8883</port>
            <bind-address>0.0.0.0</bind-address>
            <tls>
                <client-authentication-mode>${ENV:HIVEMQ_MQTTS_CLIENT_AUTH_MODE}</client-authentication-mode>
                <prefer-server-cipher-suites>${ENV:HIVEMQ_MQTTS_PREFER_SERVER_CIPHER_SUITE}</prefer-server-cipher-suites>
                <keystore>
                    <path>${ENV:HIVEMQ_MQTTS_KEYSTORE_PATH}</path>
                    <password>${ENV:HIVEMQ_MQTTS_SECRET_KEYSTORE_PASSWORD}</password>
                    <private-key-password>${ENV:HIVEMQ_MQTTS_SECRET_KEYSTORE_PASSWORD}</private-key-password>
                </keystore>
            </tls>
        </tls-tcp-listener>
        ${IF:HIVEMQ_MQTTS_ENABLED}
        ${IF:HIVEMQ_MQTTS_CLIENTAUTH_ENABLED}
        <tls-tcp-listener>
            <port>8883</port>
            <bind-address>0.0.0.0</bind-address>
            <tls>
                <client-authentication-mode>${ENV:HIVEMQ_MQTTS_CLIENT_AUTH_MODE}</client-authentication-mode>
                <prefer-server-cipher-suites>${ENV:HIVEMQ_MQTTS_PREFER_SERVER_CIPHER_SUITE}</prefer-server-cipher-suites>
                <keystore>
                    <path>${ENV:HIVEMQ_MQTTS_KEYSTORE_PATH}</path>
                    <password>${ENV:HIVEMQ_MQTTS_KEYSTORE_PASSWORD}</password>
                    <private-key-password>${ENV:HIVEMQ_MQTTS_SECRET_PRIVATE_KEY_PASSWORD}</private-key-password>
                </keystore>
                <truststore>
                    <path>${ENV:HIVEMQ_MQTTS_TRUSTSTORE_PATH}</path>
                    <password>${ENV:HIVEMQ_MQTTS_SECRET_TRUSTSTORE_PASSWORD}</password>
                </truststore>
            </tls>
        </tls-tcp-listener>
        ${IF:HIVEMQ_MQTTS_CLIENTAUTH_ENABLED}
    </mqtt-listeners>
    <mqtt-sn-listeners>
        <udp-listener>
            <port>2442</port>
            <bind-address>0.0.0.0</bind-address>
        </udp-listener>
    </mqtt-sn-listeners>
    <admin-api>
        <enabled>true</enabled>
        <listeners>
            ${IF:!HIVEMQ_HTTPS_ENABLED}
            <http-listener>
                <bind-address>0.0.0.0</bind-address>
                <port>8080</port>
            </http-listener>
            ${IF:!HIVEMQ_HTTPS_ENABLED}
            ${IF:HIVEMQ_HTTPS_ENABLED}
            <https-listener>
                <bind-address>0.0.0.0</bind-address>
                <port>8443</port>
                <tls>
                    <keystore>
                        <path>${ENV:HIVEMQ_HTTPS_KEYSTORE_PATH}</path>
                        <password>${ENV:HIVEMQ_HTTPS_KEYSTORE_PASSWORD}</password>
                        <private-key-password>${ENV:HIVEMQ_HTTPS_PRIVATE_KEY_PASSWORD}</private-key-password>
                    </keystore>
                </tls>
            </https-listener>
            ${IF:HIVEMQ_HTTPS_ENABLED}
        </listeners>
        ${IF:HIVEMQ_LDAP_ENABLED}
        <ldap>
            <servers>
                <ldap-server>
                    <host>${ENV:HIVEMQ_LDAP_SERVER1_HOST}</host>
                    <port>${ENV:HIVEMQ_LDAP_SERVER1_PORT}</port>
                </ldap-server>
                ${IF:HIVEMQ_LDAP_SERVER2_ENABLED}
                <ldap-server>
                    <host>${ENV:HIVEMQ_LDAP_SERVER2_HOST}</host>
                    <port>${ENV:HIVEMQ_LDAP_SERVER2_PORT}</port>
                </ldap-server>
                ${IF:HIVEMQ_LDAP_SERVER2_ENABLED}
                ${IF:HIVEMQ_LDAP_SERVER3_ENABLED}
                <ldap-server>
                    <host>${ENV:HIVEMQ_LDAP_SERVER3_HOST}</host>
                    <port>${ENV:HIVEMQ_LDAP_SERVER3_PORT}</port>
                </ldap-server>
                ${IF:HIVEMQ_LDAP_SERVER3_ENABLED}
            </servers>

            <tls-mode>${ENV:HIVEMQ_LDAP_TLS_MODE}</tls-mode>
            ${IF:HIVEMQ_LDAP_TLS_TRUSTSTORE_ENABLED}
            <tls>
                <truststore-path>${ENV:HIVEMQ_LDAP_TRUSTSTORE_PATH}</truststore-path>
                <truststore-password>${ENV:HIVEMQ_LDAP_TRUSTSTORE_PASSWORD}</truststore-password>
                <truststore-type>JKS</truststore-type>
            </tls>
            ${IF:HIVEMQ_LDAP_TLS_TRUSTSTORE_ENABLED}

            <simple-bind>
                <rdns>${ENV:HIVEMQ_LDAP_SIMPLEBIND_RDNS}</rdns>
                <userPassword>${ENV:HIVEMQ_LDAP_SIMPLEBIND_PASSWORD}</userPassword>
            </simple-bind>

            <uid-attribute>${ENV:HIVEMQ_LDAP_UID}</uid-attribute>
            <rdns>${ENV:HIVEMQ_LDAP_RDNS}</rdns>
            <directory-descent>${ENV:HIVEMQ_LDAP_DIRECTORY_DESCENT}</directory-descent>
            ${IF:HIVEMQ_LDAP_OBJECT_CLASS_ENABLED}
            <required-object-class>${ENV:HIVEMQ_LDAP_OBJECT_CLASS}</required-object-class>
            ${IF:HIVEMQ_LDAP_OBJECT_CLASS_ENABLED}

            <max-connections>${ENV:HIVEMQ_LDAP_MAX_CONNECTION}</max-connections>
            <connect-timeout-millis>${ENV:HIVEMQ_LDAP_CONNECT_TIMEOUT_MS}</connect-timeout-millis>
            <response-timeout-millis>${ENV:HIVEMQ_LDAP_RESPONSE_TIMEOUT_MS}</response-timeout-millis>
            <search-timeout-seconds>${ENV:HIVEMQ_LDAP_SEARCH_TIMEOUT_S}</search-timeout-seconds>
        </ldap>
        ${IF:HIVEMQ_LDAP_ENABLED}
        ${IF:HIVEMQ_USERS_ENABLED}
        <users>
            <user>
                <username>${ENV:HIVEMQ_ADMIN_USER}</username>
                <password>${ENV:HIVEMQ_ADMIN_PASSWORD}</password>
                <roles>
                    <role>admin</role>
                </roles>
            </user>
        </users>
        ${IF:HIVEMQ_USERS_ENABLED}
    </admin-api>
    <persistence>
        <mode>${ENV:HIVEMQ_PERSISTENCE_MODE}</mode>
    </persistence>

    <modules>
        ${IF:HIVEMQ_DATAHUB_ENABLED}
        <data-hub>
            <data-validation>
                <enabled>true</enabled>
            </data-validation>
            <behavior-validation>
                <enabled>true</enabled>
            </behavior-validation>
            <scripting>
                <enabled>true</enabled>
            </scripting>
            <scriptstate-persistence>
                <file>${ENV:HIVEMQ_DATAHUB_SCRIPTSTATE_PATH}</file>
            </scriptstate-persistence>
        </data-hub>
        ${IF:HIVEMQ_DATAHUB_ENABLED}
    </modules>
    ${IF:HIVEMQ_DATAHUB_ENABLED}
    <internal>
        <option>
            <key>data-hub.preset.root-folder</key>
            <value>/datahubinit</value>
        </option>
    </internal>
    ${IF:HIVEMQ_DATAHUB_ENABLED}
    ${FRAGMENT:/fragment/config}
</hivemq>
