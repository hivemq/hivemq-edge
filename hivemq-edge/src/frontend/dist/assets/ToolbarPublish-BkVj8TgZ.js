import{e as y,aR as l,bP as p,u as N,y as w,b as V,j as m,B as x,Z as K,bU as q}from"./index-cMih3SEP.js";import{D as d}from"./utils-Da84xa3e.js";import{u as Q}from"./useDataHubDraftStore-BdIk6zJn.js";import{c as j}from"./index-UJo6opCj.js";import{P as b,a as o,D as S,R as g}from"./types-CNm55BG_.js";import{a as W}from"./usePolicyGuards-DliXcvYq.js";import{d as P}from"./toast.utils-DGAijIrh.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new t.Error().stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="132f5516-1ed8-4bb8-9101-446be5ea3ee7",t._sentryDebugIdIdentifier="sentry-dbid-132f5516-1ed8-4bb8-9101-446be5ea3ee7")}catch{}})();const ct=":",ut="fn",yt="latest",lt={FIT_VIEW_DURATION_MS:500},pt=250,E={COPY:"Meta+C",PASTE:"Meta+V",ESCAPE:"ESC",BACKSPACE:"Backspace",DELETE:"Delete"},dt=[{key:"TAB",category:"Designer"},{key:"ENTER",category:"Designer"},{key:"Meta+ENTER",category:"Designer"},{key:E.PASTE,category:"Designer"},{key:E.ESCAPE,category:"Designer"},{key:E.COPY,category:"Selected"},{key:"ArrowLeft",category:"Selected"},{key:"ArrowRight",category:"Selected"},{key:"ArrowUp",category:"Selected"},{key:"ArrowDown",category:"Selected"},{key:"Backspace",category:"Selected"},{key:"Shift+drag",category:"Designer"},{key:"Meta+click",category:"Designer"}],T=()=>({node:void 0,report:void 0,status:b.IDLE}),G=j()((t,e)=>({...T(),reset:()=>{t(T())},initReport:()=>{t({report:void 0,status:b.RUNNING})},setNode:s=>{t({node:s})},setReport:s=>{const a=s.filter(u=>!!u.error);t({report:s,status:a.length?b.FAILURE:b.SUCCESS})},getErrors:()=>{const s=e().report;return s?s.filter(u=>!!u.error).map(u=>u.error):void 0}})),X=()=>{const t=y();return l({mutationFn:e=>t.dataHubDataPolicies.createDataPolicy(e),onSuccess:()=>{p.invalidateQueries({queryKey:[d.DATA_POLICIES]})}})},$=()=>{const t=y();return l({mutationFn:e=>t.dataHubBehaviorPolicies.createBehaviorPolicy(e),onSuccess:()=>{p.invalidateQueries({queryKey:[d.BEHAVIOR_POLICIES]})}})},z=()=>{const t=y();return l({mutationFn:e=>t.dataHubSchemas.createSchema(e),onSuccess:()=>{p.invalidateQueries({queryKey:[d.SCHEMAS]})}})},Z=()=>{const t=y();return l({mutationFn:e=>t.dataHubScripts.createScript(e),onSuccess:()=>{p.invalidateQueries({queryKey:[d.SCRIPTS]})}})},J=()=>{const t=y();return l({mutationFn:e=>t.dataHubDataPolicies.updateDataPolicy(e.policyId,e.requestBody),onSuccess:()=>{p.invalidateQueries({queryKey:[d.DATA_POLICIES]})}})},tt=()=>{const t=y();return l({mutationFn:e=>t.dataHubBehaviorPolicies.updateBehaviorPolicy(e.policyId,e.requestBody),onSuccess:()=>{p.invalidateQueries({queryKey:[d.BEHAVIOR_POLICIES]})}})},R=t=>(e,s)=>{if(s.node.type!==t||!s.data)return e;const{id:a}=s.data;if(!a)return e;const{version:u}=s.node.data;return u!==g.DRAFT&&u!==g.MODIFIED||e.map(I=>I.id).includes(a)||e.push(s.data),e},It=()=>{const{t}=N("datahub"),{status:e}=Q(),{report:s,node:a,setNode:u,reset:h}=G(),I=z(),O=Z(),_=X(),B=J(),k=$(),v=tt(),A=w(),H=V(),{isPolicyEditable:F}=W(),L=!!s&&s.length>=1&&(s==null?void 0:s.every(r=>!r.error)),D=r=>{A({...P,title:t("publish.internal.title",{source:a==null?void 0:a.type}),description:r,status:"error",id:"publish-internal"})},f=(r,c)=>(r.then(()=>{A({...P,title:t("publish.success.title",{source:c||(a==null?void 0:a.type)}),description:t("publish.success.description",{source:c||(a==null?void 0:a.type),context:e}),status:"success",id:"publish-success"})}).catch(n=>{let i;n instanceof Error?i=n.message:i=String(n),A({...P,title:t("publish.error.title",{source:c||(a==null?void 0:a.type)}),description:i,status:"error",id:"publish-error"})}),r),U=r=>{const c=(r==null?void 0:r.reduce(R(o.SCHEMA),[]).map(i=>({type:o.SCHEMA,payload:i,mutation:I.mutateAsync})))||[],n=(r==null?void 0:r.reduce(R(o.FUNCTION),[]).map(i=>({type:o.FUNCTION,payload:i,mutation:O.mutateAsync})))||[];return[...c,...n].map(i=>f(i.mutation(i.payload),i.type))},Y=r=>()=>{const{data:c}=r;let n;switch(!0){case(r.node.type===o.DATA_POLICY&&e===S.DRAFT):n={type:o.DATA_POLICY,payload:c,mutation:_.mutateAsync};break;case(r.node.type===o.DATA_POLICY&&e===S.MODIFIED):{const i=c;n={type:o.DATA_POLICY,payload:{policyId:i.id,requestBody:i},mutation:B.mutateAsync};break}case(r.node.type===o.BEHAVIOR_POLICY&&e===S.DRAFT):n={type:o.BEHAVIOR_POLICY,payload:c,mutation:k.mutateAsync};break;case(r.node.type===o.BEHAVIOR_POLICY&&e===S.MODIFIED):{const i=c;n={type:o.BEHAVIOR_POLICY,payload:{policyId:i.id,requestBody:i},mutation:v.mutateAsync};break}default:D(t("error.validityReport.noContext"));return}return f(n.mutation(n.payload),r.node.type)},M=()=>{if(!s)return D(t("error.validityReport.motFound"));const r=[...s].pop();if(!r)return D(t("error.validityReport.notValid"));const{resources:c}=r,n=U(c);Promise.all(n).then(Y(r)).then(()=>{h(),u(a),H(`/datahub/${a==null?void 0:a.type}/${a==null?void 0:a.data.id}`,{replace:!0})}).catch(i=>{let C;return i instanceof Error?C=i.message:C=String(i),A({...P,title:t("publish.error.title",{source:o.DATA_POLICY}),description:C.toString(),status:"error",id:"publish-runtime-error"})})};return m.jsx(x,{"data-testid":"toolbox-policy-publish",variant:"primary",leftIcon:m.jsx(K,{as:q,boxSize:"24px"}),onClick:M,isDisabled:!L||!F,isLoading:I.isPending,children:t("workspace.toolbar.policy.publish")})};export{lt as A,dt as D,ct as S,It as T,E as a,ut as b,yt as c,pt as d,G as u};
//# sourceMappingURL=ToolbarPublish-BkVj8TgZ.js.map
