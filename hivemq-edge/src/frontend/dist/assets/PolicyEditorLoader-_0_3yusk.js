import{A as Ht,N as Ft,O as Nt,j as n,m as Re,P as _t,o as et,r as b,T as N,l as M,u as k,h as we,aU as V,ac as Bt,M as Mt,s as Vt,q as $t,v as Yt,a2 as z,C as tt,bx as zt,by as nt,x as Ut,at as xe,cb as Kt,cc as qt,cd as Wt,ce as Gt,a3 as _,H as Xt,b as ve,Z as U,cw as Zt,K as Jt,cx as Qt,bp as ie,G as en,y as Pe,cy as tn,a as ot,cz as nn,cA as ce,c6 as on,cB as sn,B as st,n as rn,S as an,e as rt,f as at,co as it,au as ee,i as cn}from"./index-cMih3SEP.js";import{a as p,b as te,D as se,P as $,c as H,R as ae,f as ct,O as j,g as $e,h as dn,T as ue,B as Ye,F as ze,E as ln}from"./types-CNm55BG_.js";import{P as He,M as un,T as ge,N as fn,p as pn}from"./ToolbarButtonGroup-BOk5XENn.js";import{w as hn,t as mn,x as gn,d as yn,y as xn,z as dt,g as Cn,A as bn}from"./index-iD7yky8Q.js";import{D as In,u as fe,a as re,S as En,b as Sn,c as jn,d as Ue,T as Tn}from"./ToolbarPublish-BkVj8TgZ.js";import{M as An}from"./chunk-EL2VKIZQ-C-XtNqj-.js";import{C as lt}from"./chunk-2EW3JUUD-iAZ0BXIz.js";import{C as ut}from"./chunk-FHHZMTWR-BZ2wKB7t.js";/* empty css              */import{f as Rn,e as On,g as kn,W as Dn,B as Fe,X as ft,o as Ln,U as wn,P as D,r as X,A as pt,O as vn,Y as Pn,V as Hn}from"./index-Dis5-5gm.js";import{C as Fn}from"./chunk-KHDB22PD-BuLyJq_f.js";import{N as Ce,g as L,C as B,l as Oe,c as ht,a as Ke,b as qe}from"./SchemaNode.utils-CqHD45U7.js";import{u as Y,s as Nn}from"./useDataHubDraftStore-BdIk6zJn.js";import{a as oe,i as _n,b as Bn,v as We,c as Mn,d as Vn,g as mt,e as $n,f as gt,h as K,j as yt,P as F,k as Yn,l as xt,m as Ct,n as zn,M as Un,o as Kn,p as Ge,r as bt,q as qn,s as Xe}from"./usePolicyGuards-DliXcvYq.js";import{C as It}from"./ConfirmationDialog-D4ZhAtlq.js";import{B as Wn,a as Se}from"./chunk-QOOL75FN-CzSDf2Xj.js";import{P as Gn,b as Xn,c as Zn,d as Jn}from"./chunk-24I2HV4N-Dq0ih_Wx.js";import{P as Qn,a as eo,b as to}from"./chunk-JKY3EM6P-D6r2Lg0c.js";import{g as no}from"./color-Cs2FUV59.js";import{T as Ne,a as Et,b as oo}from"./chunk-RPO2WXNL-BTibYaQa.js";import{D as de,d as _e}from"./toast.utils-DGAijIrh.js";import{T as so,C as ro}from"./EntityTag-D_VD81fJ.js";import{D as ao}from"./chunk-W7WUSNWJ-DJm2I2MC.js";import{f as io}from"./index-BTlOwmq4.js";import{D as St}from"./utils-Da84xa3e.js";import{a as jt,u as Tt}from"./useGetAllSchemas-BHgSFldN.js";import"./index-UJo6opCj.js";import"./vanilla-Dd4Maacd.js";import"./index-C46KiF-i.js";import"./middleware-DWkoLS6u.js";import"./index-BXWYaCHO.js";import"./without-BTTCd72_.js";import"./index-DDmdO6wr.js";(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="d7e9ad39-facf-43ae-97ec-d0baa6295c62",e._sentryDebugIdIdentifier="sentry-dbid-d7e9ad39-facf-43ae-97ec-d0baa6295c62")}catch{}})();var At=Ht(function(t,o){const r=Ft("Kbd",t),{className:a,...s}=Nt(t);return n.jsx(Re.kbd,{ref:o,className:_t("chakra-kbd",a),...s,__css:{fontFamily:"mono",...r}})});At.displayName="Kbd";var co=et({d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z",displayName:"ChevronRightIcon"}),lo=et({displayName:"CloseIcon",d:"M.439,21.44a1.5,1.5,0,0,0,2.122,2.121L11.823,14.3a.25.25,0,0,1,.354,0l9.262,9.263a1.5,1.5,0,1,0,2.122-2.121L14.3,12.177a.25.25,0,0,1,0-.354l9.263-9.262A1.5,1.5,0,0,0,21.439.44L12.177,9.7a.25.25,0,0,1-.354,0L2.561.44A1.5,1.5,0,0,0,.439,2.561L9.7,11.823a.25.25,0,0,1,0,.354Z"});/* istanbul ignore file -- @preserve */const uo="MacOS",fo="Others",po=()=>{const{platform:e,userAgent:t}=navigator;let o=e;return o||(o=t),o=o.toLowerCase(),o.includes("mac")?uo:fo},ho=({hotkeys:e,description:t})=>{const r=e.split(",").map(s=>s.split("+")),a=s=>{const[i,...d]=s;return i==="Meta"?[M.t("shortcuts.modifier.META",{ns:"components",context:po()}),...d]:s};return n.jsxs(n.Fragment,{children:[n.jsx("span",{role:"term","aria-label":e,children:r.map((s,i)=>{const d=a(s);return n.jsxs(b.Fragment,{children:[i!==0&&" , ",d.map((l,u)=>n.jsxs(Re.span,{"aria-hidden":"true",children:[u!==0&&" + ",n.jsx(At,{fontSize:"md",children:l})]},`$${s}-${i}-${u}`))]},`${s}-${i}`)})}),t&&n.jsx(n.Fragment,{children:n.jsxs(N,{ml:4,as:Re.span,role:"definition",children:[" ",t]})})]})},mo=()=>{const{t:e}=k("datahub"),{isOpen:t,onOpen:o,onClose:r}=we(),a=b.useMemo(()=>In.reduce((s,i)=>(s[i.category]||(s[i.category]=[]),s[i.category].push(i),s),{}),[]);return n.jsxs(n.Fragment,{children:[n.jsx(V,{icon:n.jsx(hn,{}),onClick:o,"aria-label":e("workspace.controls.shortcuts"),"data-testid":"canvas-control-help"}),n.jsxs(Bt,{isOpen:t,onClose:r,size:"2xl",isCentered:!0,motionPreset:"scale",scrollBehavior:"inside",children:[n.jsx(Mt,{}),n.jsxs(An,{children:[n.jsx(Vt,{children:n.jsx(N,{fontSize:"md",children:e("shortcuts.header")})}),n.jsx($t,{}),n.jsx(Yt,{overflowY:"scroll",tabIndex:0,children:n.jsx(z,{gap:4,alignItems:"flex-start",children:Object.entries(a).map(([s,i])=>n.jsxs(tt,{role:"group","aria-labelledby":`group-${s}`,flex:1,children:[n.jsx(lt,{id:`group-${s}`,p:2,borderBottomWidth:1,children:e(`shortcuts.categories.${s}`)}),n.jsx(ut,{p:2,children:n.jsx(zt,{spacing:3,children:i.map(d=>n.jsx(nt,{children:n.jsx(ho,{hotkeys:d.key,description:e(`shortcuts.keys.${d.key}`,{context:d.category})})},`${s}-${d.key}`))})})]},s))})}),n.jsx(Ut,{})]})]})]})},go=({onInteractiveChange:e})=>{const{t}=k("datahub"),o=Rn(),{zoomIn:r,zoomOut:a,fitView:s}=On(),{isInteractive:i}=kn(l=>({isInteractive:l.nodesDraggable||l.nodesConnectable||l.elementsSelectable})),d=()=>{o.setState({nodesDraggable:!i,nodesConnectable:!i,elementsSelectable:!i}),e==null||e(!i)};return n.jsx(He,{position:"bottom-left",children:n.jsxs(xe,{variant:"outline",isAttached:!0,size:"sm","aria-label":t("workspace.controls.aria-label"),children:[n.jsx(V,{icon:n.jsx(Kt,{}),onClick:()=>r(),"aria-label":t("workspace.controls.zoomIn")}),n.jsx(V,{icon:n.jsx(qt,{}),onClick:()=>a(),"aria-label":t("workspace.controls.zoomIOut")}),n.jsx(V,{icon:n.jsx(mn,{}),onClick:()=>s(),"aria-label":t("workspace.controls.fitView")}),n.jsx(V,{icon:i?n.jsx(Wt,{}):n.jsx(Gt,{}),onClick:d,"aria-label":t("workspace.controls.toggleInteractivity")}),n.jsx(mo,{})]})})},ne=({value:e,...t})=>n.jsx(Ne,{as:"p",letterSpacing:"-0.05rem",fontFamily:"monospace",...t,children:n.jsx(Et,{children:e})}),G=({nodeType:e,isDisabled:t})=>{const{t:o}=k("datahub"),r=b.useCallback(a=>{t?a.preventDefault():a&&!t&&(a.dataTransfer.setData("application/reactflow",e.toString()),a.dataTransfer.effectAllowed="move")},[e,t]);return n.jsx(V,{size:"lg",onDragStart:r,draggable:!0,isDisabled:t,icon:n.jsx(Ce,{type:e}),"aria-label":o("workspace.nodes.type",{context:e})})},pe=({title:e,id:t,children:o,...r})=>n.jsx(xe,{variant:"outline",size:"sm","aria-labelledby":t,...r,children:n.jsxs(_,{alignItems:"flex-start",children:[n.jsx(Xt,{as:"h2",size:"sm",id:t,"data-testid":"toolbox-group-title",children:e}),n.jsx(z,{"data-testid":"toolbox-group-container",children:o})]})}),yo=({direction:e="horizontal"})=>{const{t}=k("datahub"),{nodes:o,isPolicyInDraft:r}=Y(),{isPolicyEditable:a}=oe(),s=o.length===0,i=e==="horizontal"?z:_;return n.jsxs(i,{pb:2,gap:5,role:"group","aria-label":t("workspace.toolbox.aria-label"),backgroundColor:"var(--chakra-colors-chakra-body-bg)",alignItems:e==="horizontal"?"center":"flex-start",children:[n.jsxs(pe,{title:t("workspace.toolbox.group.integration.edge"),id:"group-integrations",children:[n.jsx(G,{nodeType:p.TOPIC_FILTER,isDisabled:s||!a}),n.jsx(G,{nodeType:p.CLIENT_FILTER,isDisabled:s||!a})]}),n.jsxs(pe,{title:t("workspace.toolbox.group.dataPolicy"),id:"group-dataPolicy",children:[n.jsx(G,{nodeType:p.DATA_POLICY,isDisabled:!a||r()}),n.jsx(G,{nodeType:p.VALIDATOR,isDisabled:s||!a}),n.jsx(G,{nodeType:p.SCHEMA,isDisabled:s||!a})]}),n.jsxs(pe,{title:t("workspace.toolbox.group.behaviorPolicy"),id:"group-behaviorPolicy",children:[n.jsx(G,{nodeType:p.BEHAVIOR_POLICY,isDisabled:!a||r()}),n.jsx(G,{nodeType:p.TRANSITION,isDisabled:s||!a})]}),n.jsxs(pe,{title:t("workspace.toolbox.group.operation"),id:"group-operation",children:[n.jsx(G,{nodeType:p.OPERATION,isDisabled:s||!a}),n.jsx(G,{nodeType:p.FUNCTION,isDisabled:s||!a})]})]})},xo=()=>{const{t:e}=k("datahub"),{status:t,name:o,type:r,reset:a,setStatus:s}=Y(),{isPolicyEditable:i}=oe(),d=ve(),{isOpen:l,onOpen:u,onClose:f}=we();function c(){u()}function I(){s(se.MODIFIED)}function C(){s(se.DRAFT,{name:""}),d(`/datahub/${te.CREATE_POLICY}`)}function S(){f()}function m(){a(),d(`/datahub/${te.CREATE_POLICY}`)}return n.jsxs(z,{alignItems:"center",sx:{textWrap:"nowrap"},gap:4,children:[n.jsxs(z,{role:"group","aria-label":e("workspace.toolbars.status.aria-label"),children:[n.jsx(Ce,{type:p.DATA_POLICY}),n.jsxs(Wn,{separator:"|",children:[n.jsx(Se,{children:n.jsx(N,{"data-testid":"status-container-type",children:e("policy.type",{context:r||te.CREATE_POLICY})})}),n.jsx(Se,{children:n.jsx(N,{"data-testid":"status-container-name",children:o||e("policy.unnamed")})}),n.jsx(Se,{children:n.jsx(N,{"data-testid":"status-container-status",children:e("workspace.toolbox.draft.status",{context:t})})})]})]}),n.jsxs(xe,{role:"group","aria-label":e("workspace.toolbars.edit.aria-label"),children:[n.jsx(V,{isDisabled:i,"data-testid":"designer-edit-modify",onClick:I,"aria-label":e("workspace.controls.modify"),icon:n.jsx(U,{as:Zt,boxSize:"18px"})}),n.jsx(V,{isDisabled:i,"data-testid":"designer-edit-clone",onClick:C,"aria-label":e("workspace.controls.clone"),icon:n.jsx(U,{as:gn,boxSize:"18px"})}),n.jsx(V,{"data-testid":"designer-edit-clear",onClick:c,"aria-label":e("workspace.controls.clear"),icon:n.jsx(yn,{})})]}),n.jsx(It,{isOpen:l,onClose:S,onSubmit:m,message:e("workspace.toolbars.modal.clear.confirmation"),header:e("workspace.toolbars.modal.clear.header"),action:e("workspace.controls.clear")})]})},Co=()=>{const{t:e}=k("datahub"),{isPolicyEditable:t}=oe();return n.jsx(He,{position:"top-left",children:n.jsxs(z,{role:"group","aria-label":e("workspace.toolbars.draft.aria-label"),p:1,children:[n.jsx(Gn,{children:({isOpen:o})=>n.jsxs(n.Fragment,{children:[n.jsx(Xn,{children:n.jsx(Jt,{isDisabled:!t,"data-testid":"toolbox-trigger","aria-label":e("workspace.toolbox.trigger",{context:o?"close":"open"}),"aria-controls":"toolbox-content",icon:n.jsxs(n.Fragment,{children:[n.jsx(U,{as:Qt}),n.jsx(U,{as:o?Fn:co,ml:2,boxSize:"24px"})]}),px:2})}),n.jsxs(Zn,{width:"unset",id:"toolbox-content","data-testid":"toolbox-container",children:[n.jsx(Jn,{}),n.jsx(Qn,{}),n.jsx(eo,{children:e("workspace.toolbox.panel.aria-label")}),n.jsxs(to,{as:_,alignItems:"flex-start",maxWidth:"12rem",children:[n.jsx(N,{fontSize:"sm",children:e("workspace.toolbox.panel.helper")}),n.jsx(yo,{direction:"vertical"})]})]})]})}),n.jsx(xo,{})]})})},bo=()=>{const e=ie("blue.100","blue.700"),t=ie("orange.300","orange.500"),o=ie("pink.100","pink.700"),r=en(),a=s=>no(r,s===p.DATA_POLICY||s===p.BEHAVIOR_POLICY?t:s===p.SCHEMA||s===p.FUNCTION?o:e);return n.jsx(un,{zoomable:!0,pannable:!0,nodeClassName:s=>s.type||"",nodeComponent:s=>n.jsx("rect",{x:s.x,y:s.y,width:s.width,height:s.height,fill:a(s.className)})})},Io=()=>{const{setNode:e}=fe();return Dn({onChange:({nodes:t})=>{if(t.length===1){const[o]=t;if(_n(o)||Bn(o)){e(o);return}}e(void 0)}}),n.jsx("div",{})};function ke(){return ke=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},ke.apply(this,arguments)}var Rt=["shift","alt","meta","mod","ctrl"],Eo={esc:"escape",return:"enter",".":"period",",":"comma","-":"slash"," ":"space","`":"backquote","#":"backslash","+":"bracketright",ShiftLeft:"shift",ShiftRight:"shift",AltLeft:"alt",AltRight:"alt",MetaLeft:"meta",MetaRight:"meta",OSLeft:"meta",OSRight:"meta",ControlLeft:"ctrl",ControlRight:"ctrl"};function J(e){return(Eo[e]||e).trim().toLowerCase().replace(/key|digit|numpad|arrow/,"")}function So(e){return Rt.includes(e)}function je(e,t){return t===void 0&&(t=","),e.split(t)}function Te(e,t,o){t===void 0&&(t="+");var r=e.toLocaleLowerCase().split(t).map(function(i){return J(i)}),a={alt:r.includes("alt"),ctrl:r.includes("ctrl")||r.includes("control"),shift:r.includes("shift"),meta:r.includes("meta"),mod:r.includes("mod")},s=r.filter(function(i){return!Rt.includes(i)});return ke({},a,{keys:s,description:o})}(function(){typeof document<"u"&&(document.addEventListener("keydown",function(e){e.key!==void 0&&Ot([J(e.key),J(e.code)])}),document.addEventListener("keyup",function(e){e.key!==void 0&&kt([J(e.key),J(e.code)])})),typeof window<"u"&&window.addEventListener("blur",function(){Q.clear()})})();var Q=new Set;function Be(e){return Array.isArray(e)}function jo(e,t){t===void 0&&(t=",");var o=Be(e)?e:e.split(t);return o.every(function(r){return Q.has(r.trim().toLowerCase())})}function Ot(e){var t=Array.isArray(e)?e:[e];Q.has("meta")&&Q.forEach(function(o){return!So(o)&&Q.delete(o.toLowerCase())}),t.forEach(function(o){return Q.add(o.toLowerCase())})}function kt(e){var t=Array.isArray(e)?e:[e];e==="meta"?Q.clear():t.forEach(function(o){return Q.delete(o.toLowerCase())})}function To(e,t,o){(typeof o=="function"&&o(e,t)||o===!0)&&e.preventDefault()}function Ao(e,t,o){return typeof o=="function"?o(e,t):o===!0||o===void 0}function Ro(e){return Dt(e,["input","textarea","select"])}function Dt(e,t){var o=e.target;t===void 0&&(t=!1);var r=o&&o.tagName;return Be(t)?!!(r&&t&&t.some(function(a){return a.toLowerCase()===r.toLowerCase()})):!!(r&&t&&t===!0)}function Oo(e,t){return e.length===0&&t?(console.warn('A hotkey has the "scopes" option set, however no active scopes were found. If you want to use the global scopes feature, you need to wrap your app in a <HotkeysProvider>'),!0):t?e.some(function(o){return t.includes(o)})||e.includes("*"):!0}var ko=function(t,o,r){r===void 0&&(r=!1);var a=o.alt,s=o.meta,i=o.mod,d=o.shift,l=o.ctrl,u=o.keys,f=t.key,c=t.code,I=t.ctrlKey,C=t.metaKey,S=t.shiftKey,m=t.altKey,g=J(c),x=f.toLowerCase();if(!(u!=null&&u.includes(g))&&!(u!=null&&u.includes(x))&&!["ctrl","control","unknown","meta","alt","shift","os"].includes(g))return!1;if(!r){if(a===!m&&x!=="alt"||d===!S&&x!=="shift")return!1;if(i){if(!C&&!I)return!1}else if(s===!C&&x!=="meta"&&x!=="os"||l===!I&&x!=="ctrl"&&x!=="control")return!1}return u&&u.length===1&&(u.includes(x)||u.includes(g))?!0:u?jo(u):!u},Do=b.createContext(void 0),Lo=function(){return b.useContext(Do)};function Lt(e,t){return e&&t&&typeof e=="object"&&typeof t=="object"?Object.keys(e).length===Object.keys(t).length&&Object.keys(e).reduce(function(o,r){return o&&Lt(e[r],t[r])},!0):e===t}var wo=b.createContext({hotkeys:[],enabledScopes:[],toggleScope:function(){},enableScope:function(){},disableScope:function(){}}),vo=function(){return b.useContext(wo)};function Po(e){var t=b.useRef(void 0);return Lt(t.current,e)||(t.current=e),t.current}var Ze=function(t){t.stopPropagation(),t.preventDefault(),t.stopImmediatePropagation()},Ho=typeof window<"u"?b.useLayoutEffect:b.useEffect;function me(e,t,o,r){var a=b.useRef(null),s=b.useRef(!1),i=o instanceof Array?r instanceof Array?void 0:r:o,d=Be(e)?e.join(i==null?void 0:i.splitKey):e,l=o instanceof Array?o:r instanceof Array?r:void 0,u=b.useCallback(t,l??[]),f=b.useRef(u);l?f.current=u:f.current=t;var c=Po(i),I=vo(),C=I.enabledScopes,S=Lo();return Ho(function(){if(!((c==null?void 0:c.enabled)===!1||!Oo(C,c==null?void 0:c.scopes))){var m=function(y,R){var O;if(R===void 0&&(R=!1),!(Ro(y)&&!Dt(y,c==null?void 0:c.enableOnFormTags))){if(a.current!==null){var h=a.current.getRootNode();if((h instanceof Document||h instanceof ShadowRoot)&&h.activeElement!==a.current&&!a.current.contains(h.activeElement)){Ze(y);return}}(O=y.target)!=null&&O.isContentEditable&&!(c!=null&&c.enableOnContentEditable)||je(d,c==null?void 0:c.splitKey).forEach(function(A){var P,v=Te(A,c==null?void 0:c.combinationKey);if(ko(y,v,c==null?void 0:c.ignoreModifiers)||(P=v.keys)!=null&&P.includes("*")){if(c!=null&&c.ignoreEventWhen!=null&&c.ignoreEventWhen(y)||R&&s.current)return;if(To(y,v,c==null?void 0:c.preventDefault),!Ao(y,v,c==null?void 0:c.enabled)){Ze(y);return}f.current(y,v),R||(s.current=!0)}})}},g=function(y){y.key!==void 0&&(Ot(J(y.code)),((c==null?void 0:c.keydown)===void 0&&(c==null?void 0:c.keyup)!==!0||c!=null&&c.keydown)&&m(y))},x=function(y){y.key!==void 0&&(kt(J(y.code)),s.current=!1,c!=null&&c.keyup&&m(y,!0))},E=a.current||(i==null?void 0:i.document)||document;return E.addEventListener("keyup",x),E.addEventListener("keydown",g),S&&je(d,c==null?void 0:c.splitKey).forEach(function(T){return S.addHotkey(Te(T,c==null?void 0:c.combinationKey,c==null?void 0:c.description))}),function(){E.removeEventListener("keyup",x),E.removeEventListener("keydown",g),S&&je(d,c==null?void 0:c.splitKey).forEach(function(T){return S.removeHotkey(Te(T,c==null?void 0:c.combinationKey,c==null?void 0:c.description))})}}},[d,c,C]),a}const le={x:100,y:75},Fo=({render:e})=>{const{nodes:t,edges:o,onNodesChange:r,onEdgesChange:a}=Y(),[s,i]=b.useState([]),[d,l]=b.useState(le),{isPolicyEditable:u}=oe();return me(re.ESCAPE,()=>{i([]),l(le),r(t.map(f=>({id:f.id,type:"select",selected:!1})))}),me(re.COPY,()=>{if(!s.length&&!u)return;const f=t.filter(c=>c.selected);f.length?i(f):i([]),l(le)}),me(re.PASTE,()=>{if(!s.length&&!u)return;const f=s.map(m=>m.id),c=s.reduce((m,g)=>(m[g.id]=We(),m),{}),I=Fe(s,o).filter(m=>f.includes(m.source)&&f.includes(m.target)),C=s.map(m=>({...m,id:c[m.id],position:{x:m.position.x+d.x,y:m.position.y+d.y},selected:!0})),S=I.map(m=>({...m,id:We(),source:c[m.source],target:c[m.target]}));l({x:d.x+le.x,y:d.y+le.y}),r([...s.map(m=>({id:m.id,type:"select",selected:!1})),...C.map(m=>({item:m,type:"add"}))]),a([...S.map(m=>({item:m,type:"add"}))])}),(e==null?void 0:e(s))||null},No=({nbCopied:e})=>{const{t}=k("datahub");return n.jsx(He,{position:"bottom-center",children:n.jsx(xe,{variant:"outline",isAttached:!0,size:"sm","aria-label":t("workspace.toolbars.clipboard.aria-label"),children:n.jsxs(Ne,{size:"lg",variant:"subtle",userSelect:"none","data-testid":"copy-paste-status",tabIndex:0,"aria-label":t("workspace.toolbars.clipboard.content",{count:e}),children:[n.jsx(oo,{boxSize:"12px",as:e?xn:dt}),n.jsx(Et,{children:e})]})})})},_o=()=>{const{t:e}=k("datahub"),{nodes:t,edges:o,status:r,onNodesChange:a,onEdgesChange:s,setStatus:i}=Y(),{isOpen:d,onOpen:l,onClose:u}=we(),f=Pe(),{isPolicyEditable:c}=oe(),I=b.useMemo(()=>{const g=t.filter(E=>E.selected),x=o.filter(E=>E.selected);return{selectedNodes:g,selectedEdges:x}},[o,t]),C=b.useMemo(()=>{const{selectedNodes:g,selectedEdges:x}=I;return g.length+x.length},[I]),S=b.useMemo(()=>{const{selectedNodes:g,selectedEdges:x}=I;return g.length===0?"EDGE_ONLY":x.length===0?"MODE_ONLY":"BOTH"},[I]);me([re.BACKSPACE,re.DELETE],()=>{if(!c)return;const{selectedNodes:g,selectedEdges:x}=I,E=g.map(h=>Mn(h,r)),T=x.map(h=>Vn(h,t)),y=[...E,...T];if(y.length===0)return;if(y.every(h=>!!h.delete))return l();const O=y.reduce((h,A)=>(A.error&&!h.includes(A.error)&&h.push(A.error),h),[]);f.isActive(de)||f({..._e,id:de,title:e("workspace.deletion.modal.header",{count:C}),status:"error",description:n.jsxs(_,{alignItems:"flex-start",children:[n.jsx(N,{children:e("workspace.guards.delete.message",{count:C})}),n.jsx(tn,{children:O.map((h,A)=>n.jsx(nt,{children:h},`toto-${A}`))})]})})});const m=()=>{const{selectedNodes:g,selectedEdges:x}=I,E=Fe(g,o);s([...x,...E].map(T=>({id:T.id,type:"remove"}))),a(g.map(T=>({id:T.id,type:"remove"}))),i(r===se.DRAFT?se.DRAFT:se.MODIFIED)};return n.jsx(It,{isOpen:d,onClose:u,onSubmit:m,message:e("workspace.deletion.modal.message",{context:S,count:C}),header:e("workspace.deletion.modal.header",{count:C})})},Ae=50,Bo=20,Mo=({fromHandle:e,fromNode:t,fromX:o,fromY:r,toY:a,toX:s,...i})=>{const{isPolicyInDraft:d}=Y(),l=b.useMemo(()=>{const c=mt(t==null?void 0:t.type,e==null?void 0:e.id);if(!((c==null?void 0:c.type)===p.DATA_POLICY||(c==null?void 0:c.type)===p.BEHAVIOR_POLICY&&d()))return c},[e==null?void 0:e.id,t==null?void 0:t.type,d]),u={sourceX:o,sourceY:r,sourcePosition:i.fromPosition,targetX:s,targetY:a,targetPosition:i.toPosition},[f]=ft(u);return n.jsxs("g",{children:[n.jsx("path",{fill:"none",stroke:"grey",strokeWidth:1.5,className:"animated",d:f}),i.connectionStatus===null&&n.jsx("foreignObject",{x:s-(i.fromPosition==="left"?Ae:0),y:a-Bo,width:`${Ae}px`,height:`${Ae}px`,children:n.jsx(Ne,{size:"lg",colorScheme:"gray",borderRadius:"full",variant:"outline",children:n.jsx(Ce,{type:l==null?void 0:l.type})})})]})},w=e=>{const{nodes:t,edges:o}=Y(),r=Ln(),a=b.useMemo(()=>{const i=t.find(d=>d.id===r);return i?$n(e,i,o):!1},[t.length,e,o,r]);let s={width:"12px",height:"12px"};return e.type==="source"&&(s={...s,borderRadius:0}),e.position==="left"&&(s={...s,left:"-7px"}),e.position==="right"&&(s={...s,right:"-7px"}),e.position==="top"&&(s={...s,top:"-7px"}),e.position==="bottom"&&(s={...s,bottom:"-7px"}),n.jsx(wn,{...e,isConnectable:a,style:{...s,...e.style}})},Vo=({onCopy:e,onEdit:t,onDelete:o,children:r,selectedNode:a,...s})=>{const{t:i}=k("datahub"),{isNodeEditable:d}=oe(a);return n.jsxs(n.Fragment,{children:[r&&n.jsxs(n.Fragment,{children:[r,n.jsx(ao,{orientation:"vertical"})]}),n.jsxs(ge,{orientation:"horizontal",isAttached:!0,variant:"outline",...s,children:[n.jsx(V,{icon:n.jsx(U,{as:Cn,boxSize:"20px"}),"data-testid":"node-toolbar-config","aria-label":i("Listings.action.config"),onClick:t}),n.jsx(V,{icon:n.jsx(U,{as:dt,boxSize:"20px"}),"data-testid":"node-toolbar-copy","aria-label":i("Listings.action.copy"),onClick:e,isDisabled:!d})]}),n.jsx(ge,{orientation:"horizontal",isAttached:!0,variant:"outline",...s,children:n.jsx(V,{icon:n.jsx(U,{as:bn,boxSize:"20px"}),"data-testid":"node-toolbar-delete","aria-label":i("Listings.action.delete"),onClick:o,isDisabled:!d})})]})},$o=["shift","alt","meta","mod","ctrl"],Yo={esc:"escape",return:"enter",".":"period",",":"comma","-":"slash"," ":"space","`":"backquote","#":"backslash","+":"bracketright",ShiftLeft:"shift",ShiftRight:"shift",AltLeft:"alt",AltRight:"alt",MetaLeft:"meta",MetaRight:"meta",OSLeft:"meta",OSRight:"meta",ControlLeft:"ctrl",ControlRight:"ctrl"};function zo(e){return(Yo[e]||e).trim().toLowerCase().replace(/key|digit|numpad|arrow/,"")}function Je(e,t="+"){const o=e.toLocaleLowerCase().split(t).map(s=>zo(s)),r={altKey:o.includes("alt"),ctrlKey:o.includes("ctrl")||o.includes("control"),shiftKey:o.includes("shift"),metaKey:o.includes("meta"),modifierFn:o.includes("mod")},a=o.filter(s=>!$o.includes(s));return{...r,key:a[0]}}const Z=({selected:e,children:t,toolbar:o,route:r,wrapperProps:a,data:s,type:i,...d})=>{const{t:l}=k("datahub"),{nodes:u}=Y(),[f,c]=b.useState(!1),I=ve(),{pathname:C}=ot(),S=ie("blue.200","blue.700"),m=ie("orange.200","orange.700"),g=ie("pink.200","pink.700"),x=b.useMemo(()=>gt(s.dryRunStatus),[s]);b.useEffect(()=>{e||c(!1)},[e]);const E=b.useMemo(()=>u.filter(be=>be.selected).length===1,[u]),T=()=>{document.dispatchEvent(new KeyboardEvent("keydown",Je(re.COPY)))},y=()=>{document.dispatchEvent(new KeyboardEvent("keydown",Je(re.DELETE)))},R=q=>{f&&(I(r,{state:{origin:C}}),q.preventDefault(),q.stopPropagation()),c(!0)},O=i===p.DATA_POLICY||i===p.BEHAVIOR_POLICY?m:i===p.SCHEMA||i===p.FUNCTION?g:S,h={boxShadow:"var(--chakra-shadows-outline)"},A={boxShadow:"0 0 10px 2px rgba(226, 85, 85, 0.75), 0 1px 1px rgb(0 0 0 / 15%)"},P={boxShadow:"0 0 10px 2px rgba(0,121,36, 0.75), 0 1px 1px rgb(0 0 0 / 15%)"},v=s.dryRunStatus!==void 0&&s.dryRunStatus!==$.IDLE;return n.jsxs(n.Fragment,{children:[n.jsx(fn,{isVisible:e&&E,offset:16,children:n.jsx(Vo,{selectedNode:d.id,onCopy:T,onDelete:y,onEdit:R,children:o})}),n.jsxs(tt,{variant:"elevated",...s.dryRunStatus===$.FAILURE?{...A}:{},...s.dryRunStatus===$.SUCCESS?{...P}:{},...e?{...h}:{},size:"sm",onClick:R,w:"250px",children:[v&&n.jsx(nn,{position:"absolute",left:"-1rem",top:"-1rem",size:"sm",icon:n.jsx(x,{fontSize:"1.2rem"}),...s.dryRunStatus===$.FAILURE?{...A,background:"red.500"}:{},...s.dryRunStatus===$.SUCCESS?{...P,background:"green.500"}:{}}),n.jsxs(lt,{backgroundColor:O,as:z,height:12,children:[n.jsx(Ce,{type:i}),n.jsxs(N,{"data-testid":"node-title",children:[" ",l("workspace.nodes.type",{context:i})]})]}),n.jsx(ut,{...a,children:t})]})]})},Uo=e=>{var a,s;const{id:t,data:o,type:r}=e;return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${r}/${t}`,...e,children:n.jsx(_,{ml:6,alignItems:"flex-end",children:(a=o.topics)==null?void 0:a.map(i=>n.jsx(so,{tagTitle:i},i))})}),(s=o.topics)==null?void 0:s.map((i,d)=>n.jsx(w,{type:"source",isConnectable:1,position:D.Right,id:`${i}-${d}`,style:{top:L(d)}},`${t}-${i}-${d}`))]})},Ko=e=>{var a,s;const{id:t,data:o,type:r}=e;return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${r}/${t}`,...e,children:n.jsx(_,{ml:6,"data-testid":"node-model",alignItems:"flex-end",children:(a=o.clients)==null?void 0:a.map(i=>n.jsx(ro,{tagTitle:i,"data-testid":"client-wrapper"},i))})}),(s=o.clients)==null?void 0:s.map((i,d)=>n.jsx(w,{type:"source",position:D.Right,id:`${t}-${d}`,style:{top:L(d)}},`${t}-${i}-${d}`))]})};/* istanbul ignore next -- @preserve */function ye(e,t,o,r=!1){const a=Array.from(new Set(t.map(u=>u.id))),{nodes:s,edges:i}=o,d=X(e,s,i).filter(u=>!a.includes(u.id)&&u.type!==p.DATA_POLICY&&u.type!==p.BEHAVIOR_POLICY),l=pt(e,s,i).filter(u=>!a.includes(u.id)&&u.type!==p.DATA_POLICY&&u.type!==p.BEHAVIOR_POLICY);return t.push(...d,...l),l.length&&l.forEach(u=>{const f=ye(u,t,o);t=Array.from(new Set([...t,...f]))}),d.length&&!r&&d.forEach(u=>{const f=ye(u,t,o);t=Array.from(new Set([...t,...f]))}),t}function qo(e,t){const{nodes:o,edges:r}=t,a=X(e,o,r).filter(yt);return a.length?a.length>1?{node:a[0],error:F.cardinality(p.TOPIC_FILTER,e)}:{node:a[0],data:a[0].data.topics[0]}:{node:e,error:F.notConnected(p.TOPIC_FILTER,e)}}/* istanbul ignore next -- @preserve */const Wo=(e,t,o,r,a,s)=>({node:e,data:{id:e.data.id,matching:{topicFilter:t.data},validation:o.length?{validators:o.map(i=>({...i.data}))}:void 0,onFailure:a.length?{pipeline:a.map(i=>({...i.data}))}:void 0,onSuccess:r.length?{pipeline:r.map(i=>({...i.data}))}:void 0},resources:s}),Go=e=>{const t={x:0,y:0};return{item:{id:K(),type:p.DATA_POLICY,position:t,data:{id:e.id}},type:"add"}};function Xo(e,t){const{nodes:o,edges:r}=t,a=X(e,o,r).filter(xt);if(!a.length)return{node:e,error:F.notConnected(p.SCHEMA,e)};const s=a.map(d=>ht(d));return{data:{type:e.data.type,arguments:{schemas:a.map(d=>{const l=d.data.version===ae.DRAFT||d.data.version===ae.MODIFIED?"latest":d.data.version.toString();return{schemaId:d.data.name,version:l}}),strategy:e.data.strategy}},node:e,resources:[...s]}}function Zo(e,t){const{nodes:o,edges:r}=t;return X(e,o,r).filter(Yn).map(s=>Xo(s,t))}const Jo=(e,t,o)=>{var s;const r={x:o.position.x+B.Validator.x,y:o.position.y+B.Validator.y},a=[];for(const i of((s=e.validation)==null?void 0:s.validators)||[]){const d=i.arguments,l=ce(on.type,i.type.toUpperCase());if(!l)throw new Error(M.t("datahub:error.loading.connection.notFound",{type:p.VALIDATOR}));const u={id:K(),type:p.VALIDATOR,position:r,data:{strategy:d.strategy,type:l,schemas:d.schemas}};a.push({item:u,type:"add"}),a.push({source:u.id,target:o.id,sourceHandle:null,targetHandle:H.Handle.VALIDATION});let f=0;for(const c of d.schemas){const I=Oe(u,null,f++,c,t);a.push(...I)}}return a};function Qo(e,t){const{nodes:o,edges:r}=t,a=X(e,o,r).filter(Ct);return a.length?a.length>1?{error:F.cardinality(p.CLIENT_FILTER,e),node:a[0]}:{node:a[0],data:a[0].data.clients[0]}:{node:e,error:F.notConnected(p.CLIENT_FILTER,e)}}const es=(e,t)=>{const o={x:t.position.x+B.Client.x,y:t.position.y+B.Client.y},r={id:K(),type:p.CLIENT_FILTER,position:o,data:{clients:[e.matching.clientIdRegex]}};return[{item:r,type:"add"},{source:r.id,target:t.id,sourceHandle:null,targetHandle:null}]};function ts(e){return e.data.model?{node:e,data:{arguments:e.data.arguments,id:e.data.model}}:{node:e,error:F.notConfigured(e,"model")}}/* istanbul ignore next -- @preserve */function ns(e,t,o,r){return{node:e,data:{behavior:o.data,id:e.data.id,matching:{clientIdRegex:t.data},onTransitions:r.length?r.map(a=>a.data):void 0}}}const os=e=>{const t=ce(ct,e.behavior.id);if(!t)throw new Error(M.t("datahub:error.loading.connection.notFound",{type:p.BEHAVIOR_POLICY}));const o={x:0,y:0};return{item:{id:K(),type:p.BEHAVIOR_POLICY,position:o,data:{id:e.id,model:t,arguments:e.behavior.arguments}},type:"add"}},ss=e=>`${Sn}:${e.data.name}:${jn}`,rs=e=>{const t=e.functionId.split(En);return t.length!==3?t[0]:t[1]};function as(e){return!e.data.name||!e.data.version||!e.data.sourceCode?{node:e,error:F.notConfigured(e,"name, version, sourceCode")}:{data:{id:e.data.name,functionType:sn.functionType.TRANSFORMATION,source:btoa(e.data.sourceCode)},node:e}}const is=(e,t,o,r)=>{const a={x:e.position.x+B.Function.x,y:e.position.y},s=()=>(a.y+=t*B.Function.y,a),i=[];for(const d of o){const[,l]=d.functionId.split(":"),u=r.find(c=>c.id===l);if(!u)throw new Error(M.t("datahub:error.loading.connection.notFound",{type:p.FUNCTION}));const f={id:u.id,type:p.FUNCTION,position:{...s()},data:{type:"Javascript",name:u.id,version:Number(u.version),sourceCode:atob(u.source)}};i.push({item:f,type:"add"},{source:f.id,target:e.id,sourceHandle:null,targetHandle:j.Handle.FUNCTION})}return i};function cs(e,t){const{nodes:o,edges:r}=t;if(!e.data.functionId||!e.data.formData)return[{node:e,error:F.notConfigured(e,"functionId, formData")}];const a=X(e,o,r).filter(zn);if(!a.length)return[{node:e,error:F.notConnected(p.FUNCTION,e)}];const s=X(e,o,r).filter(xt),i=Fe([...s],r).filter(y=>y.targetHandle===j.Handle.SERIALISER||y.targetHandle===j.Handle.DESERIALISER),[d,...l]=i.filter(y=>y.targetHandle===j.Handle.SERIALISER),[u,...f]=i.filter(y=>y.targetHandle===j.Handle.DESERIALISER);if(d===void 0||l.length!==0)return[{node:e,error:F.notConnected(p.SCHEMA,e,j.Handle.SERIALISER)}];if(u===void 0||f.length!==0)return[{node:e,error:F.notConnected(p.SCHEMA,e,j.Handle.DESERIALISER)}];const c=a.map(y=>as(y)),I=s.map(y=>ht(y));if(!c.length)return[{node:e,error:F.notConfigured(e,"script name")}];const{transform:C}=e.data.formData,S=C.length?C:c.map(y=>{var R;return(R=y.data)==null?void 0:R.id}),m=[];for(const y of S){const R=c.find(O=>{var h;return((h=O.data)==null?void 0:h.id)===y});if(R){const O=R.node,h={functionId:ss(O),arguments:{},id:O.id};m.push({data:h,node:e})}}const g=s.find(y=>y.id===u.source);if(!g)return[{node:e,error:F.notConnected(p.SCHEMA,e,j.Handle.DESERIALISER)}];const x={functionId:j.Function.SERDES_DESERIALIZE,arguments:{schemaId:g.data.name,schemaVersion:g.data.version===ae.DRAFT||g.data.version===ae.MODIFIED?"latest":g.data.version.toString()},id:`${e.id}-deserializer`},E=s.find(y=>y.id===d.source);if(!E)return[{node:e,error:F.notConnected(p.SCHEMA,e,j.Handle.SERIALISER)}];const T={functionId:j.Function.SERDES_SERIALIZE,arguments:{schemaId:E.data.name,schemaVersion:E.data.version===ae.DRAFT||E.data.version===ae.MODIFIED?"latest":E.data.version.toString()},id:`${e.id}-serializer`};return[{data:x,node:e},...m,{data:T,node:e,resources:[...c,...I]}]}const ds=e=>(t,o)=>{if(!o.data.functionId)t.push({node:o,error:F.notConfigured(o,"functionId")});else if(o.data.functionId==="DataHub.transform"){const r=cs(o,e);t.push(...r)}else{const r={functionId:o.data.functionId,arguments:o.data.formData||{},id:o.data.id};t.push({node:o,data:r})}return t};function De(e,t,o){const{nodes:r,edges:a}=o;/* istanbul ignore next -- @preserve */const s=u=>{if(u){const f=a.find(c=>c.source===u.id);if(f){const c=r.find(I=>I.id===f.target);if(c)return c}}},[i]=a.filter(u=>u.source===e.id&&u.sourceHandle===t);if(!i)return[];const d=[];let l=r.find(u=>u.id===i.target);for(;l;)d.push(l),l=s(l);return d.reduce(ds(o),[])}const ls=(e,t,o,r)=>{const a=wt(e);if(!a)throw new Error(M.t("datahub:error.loading.operation.noTransition",{source:a}));const s=e[a];if(!s)throw new Error(M.t("datahub:error.loading.operation.noTransition",{source:a}));return Le(t,s.pipeline,null,o,r)},us=(e,t,o,r)=>{const a=[];if(e.onSuccess&&e.onSuccess.pipeline){const s=Le(r,e.onSuccess.pipeline,H.Handle.ON_SUCCESS,t,o);a.push(...s)}if(e.onFailure&&e.onFailure.pipeline){const s=Le(r,e.onFailure.pipeline,H.Handle.ON_ERROR,t,o);a.push(...s)}return a},Le=(e,t,o,r,a)=>{if(!e)throw new Error(M.t("datahub:error.loading.schema.unknown",{type:p.DATA_POLICY}));const s=o===H.Handle.ON_ERROR?B.OperationError:B.OperationSuccess,i={x:e.position.x,y:e.position.y+s.y},d=()=>(i.x+=s.x,i),l=[];let u={source:e.id,target:null,sourceHandle:o,targetHandle:null},f;for(const c of t){switch(!0){case j.Function.SERDES_DESERIALIZE===c.functionId:if(f)throw new Error(M.t("datahub:error.loading.operation.unknown"));f=[c];break;case c.functionId.startsWith("fn:"):if(!Array.isArray(f))throw new Error(M.t("datahub:error.loading.operation.unknown"));f==null||f.push(c);break;case j.Function.SERDES_SERIALIZE===c.functionId:{if(!Array.isArray(f))throw new Error(M.t("datahub:error.loading.operation.unknown"));const[I,...C]=f;f={id:K(),type:p.OPERATION,position:{...d()},data:{id:c.id,functionId:j.Function.DATAHUB_TRANSFORM,metadata:{isTerminal:!1,hasArguments:!0},formData:{transform:C.map(E=>rs(E))}}};const S=C.length+2,m=Oe(f,j.Handle.DESERIALISER,1,I.arguments,r),g=Oe(f,j.Handle.SERIALISER,S,c.arguments,r),x=is(f,2,C,a);l.push(...m),l.push(...g),l.push(...x)}break;default:if(f)throw new Error(M.t("datahub:error.loading.operation.unknown"));f={id:K(),type:p.OPERATION,position:{...d()},data:{id:c.id,functionId:c.functionId,formData:c.arguments}}}if(!f)throw new Error(M.t("datahub:error.loading.operation.unknown"));Array.isArray(f)||(l.push({item:f,type:"add"},{...u,target:f.id}),u={source:f.id,target:null,sourceHandle:null,targetHandle:null},f=void 0)}return l};function fs(e,t){const{nodes:o,edges:r}=t,a=pt(e,o,r).filter(Kn);if(!a.length)return{behaviorPolicyTransitions:[{node:e,error:F.notConnected(p.TRANSITION,e)}]};const s=[];return{behaviorPolicyTransitions:a.map(d=>{if(!d.data.event||!d.data.from||!d.data.to)return{node:d,error:F.notConfigured(d,"event, from, to")};const l=De(d,ue.Handle.OPERATION,t);s.push(...l);const f={pipeline:l.filter(c=>!!c.data).map(c=>c.data)};return{node:d,data:{fromState:d.data.from,toState:d.data.to,[d.data.event]:f}}}),pipelines:s}}const wt=e=>{if(e["Event.OnAny"])return"Event.OnAny";if(e["Connection.OnDisconnect"])return"Connection.OnDisconnect";if(e["Mqtt.OnInboundConnect"])return"Mqtt.OnInboundConnect";if(e["Mqtt.OnInboundDisconnect"])return"Mqtt.OnInboundDisconnect";if(e["Mqtt.OnInboundPublish"])return"Mqtt.OnInboundPublish";if(e["Mqtt.OnInboundSubscribe"])return"Mqtt.OnInboundSubscribe"},ps=(e,t)=>{var d;const o=(d=Un.schema.definitions)==null?void 0:d[e],{metadata:r}=o,{states:a}=r,s=ce($e,t.toState),i=a.find(l=>l.name===s);return{model:e,event:ce(dn,wt(t)||""),from:ce($e,t.fromState),to:s,type:i==null?void 0:i.type}},hs=(e,t,o,r)=>{var u;const a=ce(ct,e.behavior.id);if(!a)throw new Error(M.t("datahub:error.loading.behavior.noModel"));const s=(Math.max(((u=e.onTransitions)==null?void 0:u.length)||0,1)-1)*B.Transition.y/2,i={x:r.position.x+B.Transition.x,y:r.position.y-B.Transition.y-s},d=()=>(i.y+=B.Transition.y,i),l=[];for(const f of e.onTransitions||[]){const c={id:K(),type:p.TRANSITION,position:{...d()},data:ps(a,f)},I=ls(f,c,t,o);l.push({item:c,type:"add"},{source:r.id,target:c.id,sourceHandle:null,targetHandle:null},...I)}return l};/* istanbul ignore next -- @preserve */const Qe=(e=100)=>new Promise(t=>setTimeout(t,e)),he=(e,t)=>(t.resources&&e.push(...t.resources),e),ms=(e,t)=>(e.map(r=>r.node.id).includes(t.node.id)||e.push(t),e),gs=()=>{const e=Y(),{nodes:t,edges:o,onUpdateNodes:r}=e;/* istanbul ignore next -- @preserve */const a=async l=>{const u=t.find(c=>c.id===l.node.id),f=()=>l.error?$.FAILURE:(u==null?void 0:u.data.dryRunStatus)===$.FAILURE?$.FAILURE:$.SUCCESS;r(l.node.id,{...l.node.data,dryRunStatus:f()}),await Qe(Ue)};/* istanbul ignore next -- @preserve */const s=async(l,u)=>{for(const f of l)r(f.id,{...f.data,dryRunStatus:$.RUNNING}),await Qe(Ue);for(const f of u)await a(f);return u},i=l=>{const u=X(l,t,o).filter(yt),f=ye(l,[l,...u],e),c={...e,nodes:f},I=qo(l,c),C=Zo(l,c),S=De(l,H.Handle.ON_SUCCESS,c),m=De(l,H.Handle.ON_ERROR,c),g=S.reduce(he,[]),x=m.reduce(he,[]),E=C.reduce(he,[]),T=[...g,...x,...E].reduce(ms,[]),R=[...Ge(f),I,...C,...S,...m,...T];if(!R.some(h=>!!h.error)){const h=Wo(l,I,C,S,m,T);R.push(h)}return s(f,R)},d=l=>{/* istanbul ignore next -- @preserve */const u=X(l,t,o).filter(Ct),f=ye(l,[l,...u],e),c={...e,nodes:f},I=Qo(l,c),C=ts(l),{behaviorPolicyTransitions:S,pipelines:m}=fs(l,c),g=m==null?void 0:m.reduce(he,[]),x=Ge(f),E=[...x,...x,I,C,...S,...m||[],...g||[]];if(!E.some(y=>!!y.error)){const y=ns(l,I,C,S);E.push(y)}return s(f,E)};return{checkPolicyAsync:l=>l.type===p.DATA_POLICY?i(l):l.type===p.BEHAVIOR_POLICY?d(l):Promise.reject(new Error(`Policy Type not supported : ${l.type}`))}},ys=()=>{const{t:e}=k("datahub"),{checkPolicyAsync:t}=gs(),{isPolicyEditable:o}=oe(),{status:r,node:a,initReport:s,setReport:i}=fe(),d=b.useMemo(()=>gt(r),[r]),l=()=>{a&&(s(),t(a).then(u=>{i(u)}))};return n.jsx(st,{"data-testid":"toolbox-policy-check",leftIcon:n.jsx(U,{as:d,boxSize:"24px"}),isLoading:r===$.RUNNING,loadingText:e("workspace.dryRun.toolbar.checking"),onClick:l,isDisabled:!a||!o,"data-status":r,children:e("workspace.toolbar.policy.check")})},xs=()=>{const{t:e}=k("datahub"),{nodes:t,onUpdateNodes:o}=Y(),{node:r,setNode:a,reset:s,report:i}=fe(),d=()=>{s(),a(r),t.forEach(l=>{o(l.id,{...l.data,dryRunStatus:$.IDLE})})};return n.jsx(V,{icon:n.jsx(U,{as:lo,boxSize:"12px"}),"data-testid":"toolbox-policy-clear","aria-label":e("workspace.toolbar.policy.clearReport"),onClick:d,isDisabled:!i})},Cs=()=>{const{t:e}=k("datahub"),{report:t}=fe(),o=ve(),{pathname:r}=ot();return n.jsx(st,{leftIcon:n.jsx(U,{as:io,boxSize:"24px"}),"data-testid":"toolbox-policy-report",isDisabled:!t,onClick:()=>o("validation/",{state:{origin:r}}),children:e("workspace.toolbar.policy.showReport")})},vt=()=>{const{report:e}=fe();return n.jsxs(ge,{orientation:"horizontal",variant:"outline",gap:"0.5em",children:[n.jsx(ys,{}),n.jsxs(ge,{isAttached:!0,variant:"outline",children:[n.jsx(Cs,{}),e&&n.jsx(xs,{})]}),n.jsx(Tn,{})]})},bs=e=>{const{t}=k("datahub"),{id:o}=e;return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.DATA_POLICY}/${o}`,...e,toolbar:n.jsx(vt,{}),children:n.jsxs(z,{justifyContent:"space-between",children:[n.jsxs(_,{alignItems:"flex-start","data-testid":"node-model",children:[n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.validation",{context:H.Handle.TOPIC_FILTER})}),n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.validation",{context:H.Handle.VALIDATION})})]}),n.jsxs(_,{alignItems:"flex-end","data-testid":"node-model",children:[n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.validation",{context:H.Handle.ON_SUCCESS})}),n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.validation",{context:H.Handle.ON_ERROR})})]})]})}),n.jsx(w,{type:"target",position:D.Left,id:H.Handle.TOPIC_FILTER,style:{top:L(),borderColor:"var(--chakra-colors-black)"}}),n.jsx(w,{type:"target",position:D.Left,id:H.Handle.VALIDATION,className:H.Handle.VALIDATION,style:{top:L(1),background:"var(--chakra-colors-white)",borderColor:"var(--chakra-colors-black)",borderWidth:2}}),n.jsx(w,{type:"source",position:D.Right,id:H.Handle.ON_SUCCESS,className:H.Handle.ON_SUCCESS,style:{top:L()},isConnectable:1}),n.jsx(w,{type:"source",position:D.Right,id:H.Handle.ON_ERROR,className:H.Handle.ON_ERROR,style:{top:L(1)},isConnectable:1})]})},Is=e=>{const{id:t,data:o}=e;return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.VALIDATOR}/${t}`,...e,children:n.jsx(z,{children:n.jsxs(_,{"data-testid":"node-model",children:[n.jsx(ne,{value:o.type}),n.jsx(ne,{value:o.strategy})]})})}),n.jsx(w,{type:"target",position:D.Left,id:"target",style:{top:L(0)}}),n.jsx(w,{type:"source",position:D.Right,id:"source",style:{top:L(0)}})]})},Es=e=>{const{t}=k("datahub"),{id:o,data:r}=e,a=b.useMemo(()=>bt(r.name,r.version,t),[r.name,r.version,t]);return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.SCHEMA}/${o}`,...e,children:n.jsx(z,{justifyContent:"flex-end",children:n.jsxs(_,{"data-testid":"node-model",alignItems:"flex-end",children:[n.jsx(ne,{value:(r==null?void 0:r.type)||t("error.noSet.select")}),n.jsx(ne,{value:a})]})})}),n.jsx(w,{type:"source",position:D.Right,id:"source",style:{top:L(0)}})]})},Ss=e=>{const{t}=k("datahub"),{data:o,id:r}=e,{functionId:a,metadata:s}=o,i=(s==null?void 0:s.hasArguments)&&o.functionId==="DataHub.transform",d=(s==null?void 0:s.hasArguments)&&(o.functionId===j.Function.SERDES_SERIALIZE||o.functionId===j.Function.SERDES_DESERIALIZE);return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.OPERATION}/${r}`,...e,children:n.jsx(_,{alignItems:"flex-start",children:n.jsxs(_,{"data-testid":"node-model",alignItems:"flex-start",children:[n.jsx(ne,{value:a||t("error.noSet.select")}),d&&n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.operation",{context:j.Handle.SCHEMA})}),i&&n.jsxs(n.Fragment,{children:[n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.operation",{context:j.Handle.DESERIALISER})}),n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.operation",{context:j.Handle.FUNCTION})}),n.jsx(N,{fontSize:"xs",h:6,alignContent:"center",children:t("workspace.handles.operation",{context:j.Handle.SERIALISER})})]})]})})}),n.jsx(w,{type:"target",position:D.Left,id:j.Handle.INPUT,style:{top:L(0)}}),!(s!=null&&s.isTerminal)&&n.jsx(w,{type:"source",position:D.Right,id:j.Handle.OUTPUT,isConnectable:1,style:{top:L(0)}}),d&&n.jsx(w,{type:"target",position:D.Left,id:j.Handle.SCHEMA,style:{top:L(1),background:"var(--chakra-colors-white)",borderColor:"var(--chakra-colors-black)",borderWidth:2}}),i&&n.jsxs(n.Fragment,{children:[n.jsx(w,{type:"target",position:D.Left,id:j.Handle.DESERIALISER,style:{top:L(1),background:"var(--chakra-colors-white)",borderColor:"var(--chakra-colors-black)",borderWidth:2}}),n.jsx(w,{type:"target",position:D.Left,id:j.Handle.FUNCTION,style:{top:L(2),background:"var(--chakra-colors-white)",borderColor:"var(--chakra-colors-black)",borderWidth:2}}),n.jsx(w,{type:"target",position:D.Left,id:j.Handle.SERIALISER,style:{top:L(3),background:"var(--chakra-colors-white)",borderColor:"var(--chakra-colors-black)",borderWidth:2}})]})]})},js=e=>{const{t}=k("datahub"),{id:o,data:r}=e,a=b.useMemo(()=>bt(r.name,r.version,t),[r.name,r.version,t]);return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.FUNCTION}/${o}`,...e,children:n.jsx(z,{justifyContent:"flex-end",children:n.jsx(_,{"data-testid":"node-model",alignItems:"flex-end",children:n.jsx(ne,{value:a||t("error.noSet.select")})})})}),n.jsx(w,{type:"source",position:D.Right,id:"source",style:{top:L(0)}})]})},Ts=e=>{const{t}=k("datahub"),{id:o,data:r}=e;return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.BEHAVIOR_POLICY}/${o}`,toolbar:n.jsx(vt,{}),...e,children:n.jsx(_,{"data-testid":"node-model",alignItems:"flex-end",children:n.jsx(ne,{value:r.model||t("error.noSet.select")})})}),n.jsx(w,{type:"target",position:D.Left,id:Ye.Handle.CLIENT_FILTER,style:{top:L(0)}}),n.jsx(w,{type:"source",position:D.Right,id:Ye.Handle.TRANSITIONS,style:{top:L(0)}})]})},As=e=>{const{t}=k("datahub"),{data:o,id:r}=e,a=b.useMemo(()=>{if(o.type===ze.Type.SUCCESS)return ue.Handle.ON_SUCCESS;if(o.type===ze.Type.FAILED)return ue.Handle.ON_ERROR},[o.type]);return n.jsxs(n.Fragment,{children:[n.jsx(Z,{route:`node/${p.TRANSITION}/${r}`,...e,children:n.jsx(_,{"data-testid":"node-model",alignItems:"flex-end",children:n.jsx(ne,{value:o.event||t("error.noSet.select")})})}),n.jsx(w,{type:"target",position:D.Left,id:ue.Handle.BEHAVIOR_POLICY,style:{top:L(0)}}),n.jsx(w,{type:"source",id:ue.Handle.OPERATION,position:D.Right,isConnectable:1,className:a,style:{top:L(0)}})]})},Rs=e=>{const{sourceX:t,sourceY:o,sourcePosition:r,targetX:a,targetY:s,targetPosition:i,markerEnd:d,style:l}=e,[u]=ft({sourceX:t,sourceY:o,sourcePosition:r,targetX:a,targetY:s,targetPosition:i}),f=e.selected&&{filter:"drop-shadow( 1px 1px 2px rgba(0, 0, 0, .5))"},c={...l,...Nn.style,...f};return n.jsx(vn,{path:u,markerEnd:d,style:c})},Os={[p.TOPIC_FILTER]:Uo,[p.CLIENT_FILTER]:Ko,[p.DATA_POLICY]:bs,[p.VALIDATOR]:Is,[p.SCHEMA]:Es,[p.OPERATION]:Ss,[p.FUNCTION]:js,[p.BEHAVIOR_POLICY]:Ts,[p.TRANSITION]:As},ks={[ln.DATAHUB_EDGE]:Rs},Me=()=>{const{t:e}=k("datahub"),t=b.useRef(null),[o,r]=b.useState(null),{status:a,nodes:s,edges:i,onNodesChange:d,onEdgesChange:l,onConnect:u,onAddNodes:f,isPolicyInDraft:c,setStatus:I}=Y(),C=b.useRef(void 0),S=b.useMemo(()=>Os,[]),m=b.useMemo(()=>ks,[]),{isPolicyEditable:g}=oe(),x=b.useCallback(h=>qn(h,s,i),[i,s]),E=b.useCallback(h=>{h&&(h.preventDefault(),h.dataTransfer.dropEffect="move")},[]),T=b.useCallback(h=>{if(h&&o){h.preventDefault();const A=h.dataTransfer.getData("application/reactflow");if(typeof A>"u"||!A)return;const P=o.screenToFlowPosition({x:h.clientX,y:h.clientY}),v={id:K(A),type:A,position:P,data:Xe(A)};f([{item:v,type:"add"}]),(A===p.DATA_POLICY||A===p.BEHAVIOR_POLICY)&&I(a,{type:A})}},[f,o,I,a]),y=b.useCallback((h,A)=>{if(!g)return;const P=s.find(v=>v.id===A.nodeId);C.current=void 0,P&&(C.current={...A,type:P.type})},[g,s]),R=b.useCallback(h=>{if(h.target.classList.contains("react-flow__pane")&&C.current&&o){const{type:v,handleId:q,handleType:be,nodeId:Ve}=C.current,W=mt(v,q);if(!W||W.type===p.DATA_POLICY||W.type===p.BEHAVIOR_POLICY&&c())return;if(W){const Ie=K(),Ee={id:Ie,position:o.screenToFlowPosition({x:h.clientX||h.touches[0].clientX,y:h.clientY||h.touches[0].clientY}),type:W.type,data:Xe(W.type)};Ee.position.y+=Ke.y,be==="target"&&(Ee.position.x+=Ke.x);const Pt=W.isSource?{target:Ve,targetHandle:q,source:Ie,sourceHandle:W.handle}:{source:Ve,sourceHandle:q,target:Ie,targetHandle:W.handle};f([{item:Ee,type:"add"}]),u(Pt)}}},[c,f,u,o]),O=b.useCallback(h=>{C.current=void 0,u(h)},[u]);return n.jsx(n.Fragment,{children:n.jsxs(Pn,{children:[n.jsx(Hn,{ref:t,id:"edge-datahub-canvas",nodes:s,edges:i,nodeTypes:S,edgeTypes:m,onNodesChange:d,onEdgesChange:l,onConnectStart:y,onConnectEnd:R,onConnect:O,connectionRadius:35,connectionLineComponent:g?Mo:void 0,onInit:r,fitView:!0,snapToGrid:!0,snapGrid:[qe,qe],onDragOver:E,onDrop:T,isValidConnection:x,deleteKeyCode:[],nodesConnectable:g,proOptions:pn,role:"region","aria-label":e("workspace.canvas.aria-label"),children:n.jsxs(rn,{role:"toolbar","aria-label":e("workspace.toolbars.aria-label"),"aria-controls":"edge-datahub-canvas",children:[n.jsx(_o,{}),n.jsx(Io,{}),n.jsx(Co,{}),n.jsx(go,{}),n.jsx(Fo,{render:h=>n.jsx(No,{nbCopied:h.length})}),n.jsx(bo,{})]})}),n.jsx(an,{})]})})},Ds=(e,t)=>{const o=rt();return at({queryKey:[St.DATA_POLICIES,e,t],queryFn:()=>o.dataHubDataPolicies.getDataPolicy(e,t)})},Ls=(e,t)=>{const o=rt();return at({queryKey:[St.BEHAVIOR_POLICIES,e,t],queryFn:()=>o.dataHubBehaviorPolicies.getBehaviorPolicy(e,t)})},ws=(e,t)=>{const o={x:t.position.x+B.Topic.x,y:t.position.y+B.Topic.y},r={id:K(),type:p.TOPIC_FILTER,position:o,data:{adapter:void 0,topics:[e.matching.topicFilter]}};return[{item:r,type:"add"},{source:r.id,target:t.id,sourceHandle:null,targetHandle:null}]},vs=({policyId:e})=>{const{t}=k("datahub"),o=Y(),r=Pe(),{isLoading:a,data:s,isError:i,error:d}=Ds(e),{isLoading:l,data:u,isError:f,error:c}=jt({}),{isLoading:I,data:C,isError:S,error:m}=Tt();return b.useEffect(()=>{if(!(!s||!C||!u))try{o.reset();const g=Go(s),x=ws(s,g.item),E=Jo(s,C.items||[],g.item),T=us(s,C.items||[],u.items||[],g.item),y=[g,...x,...E,...T],R=y.reduce((h,A)=>{const P=h.map(q=>q.item.id),v=A;return v.item&&!P.includes(v.item.id)&&h.push(v),h},[]),O=y.filter(h=>!!h.source);o.onNodesChange(R);for(const h of O)o.onConnect(h);o.setStatus(se.LOADED,{name:s.id,type:p.DATA_POLICY})}catch(g){let x;g instanceof Error?x=g.message:x=String(g),r.isActive(de)||r({..._e,id:de,title:t("error.load.errorTitle",{source:te.DATA_POLICY}),description:x,status:"error"})}},[s,C,u,t,r]),a||l||I?n.jsx(it,{}):i?n.jsx(ee,{type:t("error.notDefined.title"),message:d==null?void 0:d.message}):f?n.jsx(ee,{type:t("error.notDefined.title"),message:c==null?void 0:c.message}):S?n.jsx(ee,{type:t("error.notDefined.title"),message:m==null?void 0:m.message}):n.jsx(Me,{})},Ps=({policyId:e})=>{const{t}=k("datahub"),o=Y(),r=Pe(),{isLoading:a,data:s,isError:i,error:d}=Ls(e),{isLoading:l,data:u,isError:f,error:c}=jt({}),{isLoading:I,data:C,isError:S,error:m}=Tt();return b.useEffect(()=>{if(!(!s||!C||!u))try{o.reset();const g=os(s),x=es(s,g.item),E=hs(s,C.items||[],u.items||[],g.item),T=[g,...x,...E],y=T.reduce((O,h)=>{const A=O.map(v=>v.item.id),P=h;return P.item&&!A.includes(P.item.id)&&O.push(P),O},[]),R=T.filter(O=>!!O.source);o.onNodesChange(y);for(const O of R)o.onConnect(O);o.setStatus(se.LOADED,{name:s.id,type:p.BEHAVIOR_POLICY})}catch(g){let x;g instanceof Error?x=g.message:x=String(g),r.isActive(de)||r({..._e,id:de,title:t("error.load.errorTitle",{source:te.DATA_POLICY}),description:x,status:"error"})}},[s,C,u,t,r]),a||l||I?n.jsx(it,{}):i?n.jsx(ee,{type:t("error.notDefined.title"),message:d==null?void 0:d.message}):f?n.jsx(ee,{type:t("error.notDefined.title"),message:c==null?void 0:c.message}):S?n.jsx(ee,{type:t("error.notDefined.title"),message:m==null?void 0:m.message}):n.jsx(Me,{})},hr=()=>{const{t:e}=k("datahub"),{policyType:t,policyId:o}=cn();return!t||!(t in te)?n.jsx(ee,{type:e("error.notDefined.title"),message:e("error.notDefined.description")}):o?t===te.DATA_POLICY?n.jsx(vs,{policyId:o}):t===te.BEHAVIOR_POLICY?n.jsx(Ps,{policyId:o}):n.jsx(ee,{type:e("error.notDefined.title"),message:e("error.notDefined.description")}):n.jsx(Me,{})};export{Ps as BehaviorPolicyLoader,vs as DataPolicyLoader,hr as default};
//# sourceMappingURL=PolicyEditorLoader-_0_3yusk.js.map
