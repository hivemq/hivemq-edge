{"version":3,"file":"revertJSONPatch.js","names":["existsIn","getIn","immutableJSONPatch","isArrayItem","parseFrom","parsePath","compileJSONPointer","startsWith","revertJSONPatch","document","operations","options","allRevertOperations","before","operation","revertOperations","path","op","revertAdd","revertRemove","revertReplace","revertCopy","revertMove","from","Error","JSON","stringify","updatedJson","res","json","concat","undefined","value","length","move"],"sources":["../../src/revertJSONPatch.ts"],"sourcesContent":["import { existsIn, getIn } from './immutabilityHelpers.js'\nimport {\n  immutableJSONPatch,\n  isArrayItem,\n  parseFrom,\n  parsePath\n} from './immutableJSONPatch.js'\nimport { compileJSONPointer } from './jsonPointer.js'\nimport {\n  JSONPatchAdd,\n  JSONPatchDocument,\n  JSONPatchMove, JSONPatchOperation, JSONPatchOptions,\n  JSONPatchRemove,\n  JSONPatchReplace,\n  JSONPath,\n  RevertJSONPatchOptions\n} from './types.js'\nimport { startsWith } from './utils.js'\n\n/**\n * Create the inverse of a set of json patch operations\n * @param document\n * @param operations Array with JSON patch actions\n * @param [options]\n * @return Returns the operations to revert the changes\n */\nexport function revertJSONPatch<T, U> (document: T, operations: JSONPatchDocument, options?: RevertJSONPatchOptions) : JSONPatchDocument {\n  let allRevertOperations: JSONPatchDocument = []\n\n  const before: JSONPatchOptions['before'] = <TT, UU>(document: TT, operation: JSONPatchOperation) : { document?: UU, operation?: JSONPatchOperation } => {\n    let revertOperations: JSONPatchDocument\n    const path = parsePath(document, operation.path)\n    if (operation.op === 'add') {\n      revertOperations = revertAdd(document, path)\n    } else if (operation.op === 'remove') {\n      revertOperations = revertRemove(document, path)\n    } else if (operation.op === 'replace') {\n      revertOperations = revertReplace(document, path)\n    } else if (operation.op === 'copy') {\n      revertOperations = revertCopy(document, path)\n    } else if (operation.op === 'move') {\n      revertOperations = revertMove(document, path, parseFrom(operation.from))\n    } else if (operation.op === 'test') {\n      revertOperations = []\n    } else {\n      throw new Error('Unknown JSONPatch operation ' + JSON.stringify(operation))\n    }\n\n    let updatedJson: UU\n    if (options && options.before) {\n      const res = options.before(document, operation, revertOperations)\n      if (res && res.revertOperations) {\n        revertOperations = res.revertOperations\n      }\n      if (res && res.document) {\n        updatedJson = res.document as unknown as UU\n      }\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      if (res && res.json) {\n        // TODO: deprecated since v5.0.0. Cleanup this warning some day\n        throw new Error('Deprecation warning: returned object property \".json\" has been renamed to \".document\"')\n      }\n    }\n\n    allRevertOperations = revertOperations.concat(allRevertOperations)\n\n    if (updatedJson !== undefined) {\n      return {\n        document: updatedJson\n      }\n    }\n  }\n\n  immutableJSONPatch<U, T>(document, operations, { before })\n\n  return allRevertOperations\n}\n\nfunction revertReplace<T> (document: T, path: JSONPath) : [JSONPatchReplace] {\n  return [{\n    op: 'replace',\n    path: compileJSONPointer(path),\n    value: getIn(document, path)\n  }]\n}\n\nfunction revertRemove<T> (document: T, path: JSONPath) : [JSONPatchAdd] {\n  return [{\n    op: 'add',\n    path: compileJSONPointer(path),\n    value: getIn(document, path)\n  }]\n}\n\nfunction revertAdd<T> (document: T, path: JSONPath) : [JSONPatchRemove] | [JSONPatchReplace] {\n  if (isArrayItem(document, path) || !existsIn(document, path)) {\n    return [{\n      op: 'remove',\n      path: compileJSONPointer(path)\n    }]\n  } else {\n    return revertReplace(document, path)\n  }\n}\n\nfunction revertCopy<T> (document: T, path: JSONPath) : [JSONPatchRemove] | [JSONPatchReplace] {\n  return revertAdd(document, path)\n}\n\nfunction revertMove<T> (document: T, path: JSONPath, from: JSONPath) : [JSONPatchReplace] | [JSONPatchMove] | [JSONPatchMove, JSONPatchAdd] {\n  if (path.length < from.length && startsWith(from, path)) {\n    // replacing the parent with the child\n    return [\n      {\n        op: 'replace',\n        path: compileJSONPointer(path),\n        value: document\n      }\n    ]\n  }\n\n  const move: JSONPatchMove = {\n    op: 'move',\n    from: compileJSONPointer(path),\n    path: compileJSONPointer(from)\n  }\n\n  if (!isArrayItem(document, path) && existsIn(document, path)) {\n    // the move replaces an existing value in an object\n    return [\n      move,\n      ...revertRemove(document, path)\n    ]\n  } else {\n    return [\n      move\n    ]\n  }\n}\n"],"mappings":"AAAA,SAASA,QAAQ,EAAEC,KAAK,QAAQ,0BAA0B;AAC1D,SACEC,kBAAkB,EAClBC,WAAW,EACXC,SAAS,EACTC,SAAS,QACJ,yBAAyB;AAChC,SAASC,kBAAkB,QAAQ,kBAAkB;AAUrD,SAASC,UAAU,QAAQ,YAAY;;AAEvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,eAAeA,CAAQC,QAAW,EAAEC,UAA6B,EAAEC,OAAgC,EAAsB;EACvI,IAAIC,mBAAsC,GAAG,EAAE;EAE/C,MAAMC,MAAkC,GAAGA,CAASJ,QAAY,EAAEK,SAA6B,KAAyD;IACtJ,IAAIC,gBAAmC;IACvC,MAAMC,IAAI,GAAGX,SAAS,CAACI,QAAQ,EAAEK,SAAS,CAACE,IAAI,CAAC;IAChD,IAAIF,SAAS,CAACG,EAAE,KAAK,KAAK,EAAE;MAC1BF,gBAAgB,GAAGG,SAAS,CAACT,QAAQ,EAAEO,IAAI,CAAC;IAC9C,CAAC,MAAM,IAAIF,SAAS,CAACG,EAAE,KAAK,QAAQ,EAAE;MACpCF,gBAAgB,GAAGI,YAAY,CAACV,QAAQ,EAAEO,IAAI,CAAC;IACjD,CAAC,MAAM,IAAIF,SAAS,CAACG,EAAE,KAAK,SAAS,EAAE;MACrCF,gBAAgB,GAAGK,aAAa,CAACX,QAAQ,EAAEO,IAAI,CAAC;IAClD,CAAC,MAAM,IAAIF,SAAS,CAACG,EAAE,KAAK,MAAM,EAAE;MAClCF,gBAAgB,GAAGM,UAAU,CAACZ,QAAQ,EAAEO,IAAI,CAAC;IAC/C,CAAC,MAAM,IAAIF,SAAS,CAACG,EAAE,KAAK,MAAM,EAAE;MAClCF,gBAAgB,GAAGO,UAAU,CAACb,QAAQ,EAAEO,IAAI,EAAEZ,SAAS,CAACU,SAAS,CAACS,IAAI,CAAC,CAAC;IAC1E,CAAC,MAAM,IAAIT,SAAS,CAACG,EAAE,KAAK,MAAM,EAAE;MAClCF,gBAAgB,GAAG,EAAE;IACvB,CAAC,MAAM;MACL,MAAM,IAAIS,KAAK,CAAC,8BAA8B,GAAGC,IAAI,CAACC,SAAS,CAACZ,SAAS,CAAC,CAAC;IAC7E;IAEA,IAAIa,WAAe;IACnB,IAAIhB,OAAO,IAAIA,OAAO,CAACE,MAAM,EAAE;MAC7B,MAAMe,GAAG,GAAGjB,OAAO,CAACE,MAAM,CAACJ,QAAQ,EAAEK,SAAS,EAAEC,gBAAgB,CAAC;MACjE,IAAIa,GAAG,IAAIA,GAAG,CAACb,gBAAgB,EAAE;QAC/BA,gBAAgB,GAAGa,GAAG,CAACb,gBAAgB;MACzC;MACA,IAAIa,GAAG,IAAIA,GAAG,CAACnB,QAAQ,EAAE;QACvBkB,WAAW,GAAGC,GAAG,CAACnB,QAAyB;MAC7C;MACA;MACA;MACA,IAAImB,GAAG,IAAIA,GAAG,CAACC,IAAI,EAAE;QACnB;QACA,MAAM,IAAIL,KAAK,CAAC,uFAAuF,CAAC;MAC1G;IACF;IAEAZ,mBAAmB,GAAGG,gBAAgB,CAACe,MAAM,CAAClB,mBAAmB,CAAC;IAElE,IAAIe,WAAW,KAAKI,SAAS,EAAE;MAC7B,OAAO;QACLtB,QAAQ,EAAEkB;MACZ,CAAC;IACH;EACF,CAAC;EAEDzB,kBAAkB,CAAOO,QAAQ,EAAEC,UAAU,EAAE;IAAEG;EAAO,CAAC,CAAC;EAE1D,OAAOD,mBAAmB;AAC5B;AAEA,SAASQ,aAAaA,CAAKX,QAAW,EAAEO,IAAc,EAAuB;EAC3E,OAAO,CAAC;IACNC,EAAE,EAAE,SAAS;IACbD,IAAI,EAAEV,kBAAkB,CAACU,IAAI,CAAC;IAC9BgB,KAAK,EAAE/B,KAAK,CAACQ,QAAQ,EAAEO,IAAI;EAC7B,CAAC,CAAC;AACJ;AAEA,SAASG,YAAYA,CAAKV,QAAW,EAAEO,IAAc,EAAmB;EACtE,OAAO,CAAC;IACNC,EAAE,EAAE,KAAK;IACTD,IAAI,EAAEV,kBAAkB,CAACU,IAAI,CAAC;IAC9BgB,KAAK,EAAE/B,KAAK,CAACQ,QAAQ,EAAEO,IAAI;EAC7B,CAAC,CAAC;AACJ;AAEA,SAASE,SAASA,CAAKT,QAAW,EAAEO,IAAc,EAA2C;EAC3F,IAAIb,WAAW,CAACM,QAAQ,EAAEO,IAAI,CAAC,IAAI,CAAChB,QAAQ,CAACS,QAAQ,EAAEO,IAAI,CAAC,EAAE;IAC5D,OAAO,CAAC;MACNC,EAAE,EAAE,QAAQ;MACZD,IAAI,EAAEV,kBAAkB,CAACU,IAAI;IAC/B,CAAC,CAAC;EACJ,CAAC,MAAM;IACL,OAAOI,aAAa,CAACX,QAAQ,EAAEO,IAAI,CAAC;EACtC;AACF;AAEA,SAASK,UAAUA,CAAKZ,QAAW,EAAEO,IAAc,EAA2C;EAC5F,OAAOE,SAAS,CAACT,QAAQ,EAAEO,IAAI,CAAC;AAClC;AAEA,SAASM,UAAUA,CAAKb,QAAW,EAAEO,IAAc,EAAEO,IAAc,EAAyE;EAC1I,IAAIP,IAAI,CAACiB,MAAM,GAAGV,IAAI,CAACU,MAAM,IAAI1B,UAAU,CAACgB,IAAI,EAAEP,IAAI,CAAC,EAAE;IACvD;IACA,OAAO,CACL;MACEC,EAAE,EAAE,SAAS;MACbD,IAAI,EAAEV,kBAAkB,CAACU,IAAI,CAAC;MAC9BgB,KAAK,EAAEvB;IACT,CAAC,CACF;EACH;EAEA,MAAMyB,IAAmB,GAAG;IAC1BjB,EAAE,EAAE,MAAM;IACVM,IAAI,EAAEjB,kBAAkB,CAACU,IAAI,CAAC;IAC9BA,IAAI,EAAEV,kBAAkB,CAACiB,IAAI;EAC/B,CAAC;EAED,IAAI,CAACpB,WAAW,CAACM,QAAQ,EAAEO,IAAI,CAAC,IAAIhB,QAAQ,CAACS,QAAQ,EAAEO,IAAI,CAAC,EAAE;IAC5D;IACA,OAAO,CACLkB,IAAI,EACJ,GAAGf,YAAY,CAACV,QAAQ,EAAEO,IAAI,CAAC,CAChC;EACH,CAAC,MAAM;IACL,OAAO,CACLkB,IAAI,CACL;EACH;AACF"}